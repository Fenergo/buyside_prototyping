<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monitoring & Screening · KYC Orchestrator</title>
  <style>
  :root{
    --sidebar-bg: #f7fafd;
    --sidebar-icon: #4976a4;
    --sidebar-text: #4976a4;
    --sidebar-width: 80px;
    --sidebar-font-size: 12px;
    --sidebar-title-size: 13px;
    --sidebar-tag-size: 10px;
    --sidebar-icon-size: 28px;
    --sidebar-active: #e3eefa;
    --sidebar-width: 170px;
    --sidebar-font-size: 11px;
    --sidebar-title-size: 13px;
    --sidebar-tag-size: 10px;
    --sidebar-icon-size: 18px;
    --page:#ffffff;
    --text:#0f172a;
    --muted:#475569;
    --line:#e5e7eb;
    --card:#ffffff;
    --sidebar: rgba(33,207,178,0.20);
    --btn: rgba(33,207,178,0.60);
    --btn-border: rgba(33,207,178,0.60);
    --btn-text:#0b1220;
    --link:#0ea5e9;
    --task:#a399ff;
    --success:#059669;
    --warn:#d97706;
    --danger:#dc2626;
    --info:#2563eb;
    --progress:#21cfb2;
  }
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial;
  background: var(--page);
  color:var(--text);
  line-height:1.45;
}
a{color:var(--link); text-decoration:none}
a:hover{text-decoration:underline}

/* Layout */

.app{display:grid; grid-template-columns: var(--sidebar-width) 1fr; min-height:100vh}
.sidebar {
  background: var(--sidebar-bg);
  border-right: 1px solid var(--line);
  width: var(--sidebar-width);
  min-width: var(--sidebar-width);
  max-width: var(--sidebar-width);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  height: 100vh;
  padding: 0;
}
.sidebar .brand {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 24px 0 0 0;
}
.sidebar .logo {
  width: 36px;
  height: 36px;
  border-radius: 12px;
  background: radial-gradient(circle at 25% 20%, #4976a4 0%, #e3eefa 100%);
  margin-bottom: 8px;
}
.sidebar .brand h1 {
  font-size: 14px;
  color: var(--sidebar-text);
  margin: 0;
  font-weight: 600;
  letter-spacing: 0.2px;
}
.sidebar .nav {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 28px;
  margin-top: 24px;
}
.sidebar .nav a {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  color: var(--sidebar-text);
  text-decoration: none;
  font-size: var(--sidebar-font-size);
  padding: 0;
  border-radius: 8px;
  width: 100%;
  transition: background 0.15s;
}
.sidebar .nav a.active, .sidebar .nav a:hover {
  background: var(--sidebar-active);
}
.sidebar .nav .icon {
  width: var(--sidebar-icon-size);
  height: var(--sidebar-icon-size);
  color: var(--sidebar-icon);
  display: block;
}
.sidebar .nav .text {
  font-size: var(--sidebar-font-size);
  color: var(--sidebar-text);
  text-align: center;
  margin-top: 2px;
}
.sidebar .nav .tag {
  display: none;
}
.sidebar .footer-note {
  margin-top: 10px;
  font-size: 10px;
  color: var(--muted);
  opacity: .85;
  padding: 0 3px;
  margin-bottom: 18px;
}

/* Top bar */
.header{
  display:flex; align-items:center; justify-content:space-between;
  padding:16px 22px; position:sticky; top:0; z-index:5;
  background:rgba(255,255,255,0.9);
  backdrop-filter: blur(6px);
  border-bottom: 1px solid var(--line);
}
.search{
  display:flex; align-items:center; gap:8px; border:1px solid var(--line);
  background: var(--card);
  padding:10px 12px; border-radius:12px; width:52%;
}
.search input{
  flex:1; background:transparent; border:none; outline:none; color:var(--text);
}
.actions{display:flex; align-items:center; gap:10px}
.btn{
  background: var(--btn);
  border:1px solid var(--btn-border);
  color:var(--btn-text); padding:4px 8px; border-radius:8px; cursor:pointer;
  transition: filter .15s ease, transform .02s ease;
}
.btn:hover{filter:brightness(1.05)}
.btn:active{transform:translateY(1px)}
.btn.primary{background: var(--btn); border-color: var(--btn-border)}
.btn.ghost{background:transparent; color: var(--btn-text); border-color: var(--btn-border)}
.btn.small{padding:3px 7px; font-size:11px}
.kbd{font: 12px/1.6 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; padding:2px 6px; border-radius:6px; border:1px solid var(--line); color:var(--muted)}

/* Content */
.content{padding:14px 22px 40px}
.page-title{display:flex; align-items:baseline; justify-content:space-between; gap:12px; margin:12px 0 8px 0}
.page-title h2{margin:0; font-size:22px}
.page-title .sub{color:var(--muted)}

/* Cards & sections */
.cards{display:grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap:14px; margin:14px 0 6px}
.card{
  background: var(--card);
  border:1px solid var(--line); border-radius:14px; padding:12px 14px; min-height:72px;
  box-shadow: 0 8px 28px rgba(2,6,23,.06);
}
.card .label{color:var(--muted); font-size:12px}
.card .value{font-size:22px; margin-top:2px}
.card .trend{font-size:12px; color:#047857}
.card .danger{color:var(--danger)}

.grid-2{display:grid; grid-template-columns: 2fr 1fr; gap:16px; margin-top:16px}
.grid-3{display:grid; grid-template-columns: repeat(3, 1fr); gap:16px; margin-top:16px}
.section{background: var(--card); border:1px solid var(--line); border-radius:14px; padding:8px 10px}
.section h3{margin:0 0 6px 0; font-size:14px}

/* Table */
.table{width:100%; border-collapse:separate; border-spacing:0 4px; font-size:12px}
.table th{color:var(--muted); text-align:left; font-weight:600; padding:4px 6px; border-bottom:1px solid var(--line)}
.table td{padding:4px 6px; background:#ffffff; border:1px solid var(--line)}
.table tr td:first-child{border-top-left-radius:10px; border-bottom-left-radius:10px}
.table tr td:last-child{border-top-right-radius:10px; border-bottom-right-radius:10px}

/* Badges & pills */
.badge{font-size:10px; padding:2px 6px; border-radius:999px; border:1px solid var(--line); background:#f8fafc; color:#0b1220}
.badge.ok{border-color:#065f46; background:#ecfdf5; color:#065f46}
.badge.warn{border-color:#92400e; background:#fffbeb; color:#92400e}
.badge.danger{border-color:#7f1d1d; background:#fef2f2; color:#7f1d1d}
.badge.info{border-color:#1e3a8a; background:#eff6ff; color:#1e3a8a}
/* Action task badge in requested color */
.badge.task{border-color:#6f63ff; background:#a399ff; color:#ffffff}

.pills{display:flex; gap:8px; flex-wrap:wrap}
.pill{padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:#f8fafc; cursor:pointer; font-size:12px; color:#0b1220}
.pill.active{background:rgba(33,207,178,0.18); border-color:rgba(33,207,178,0.28)}

/* Progress */
.progress{width:100%; height:10px; border-radius:999px; background:#f1f5f9; border:1px solid var(--line); overflow:hidden}
.progress > span{display:block; height:100%; background:linear-gradient(90deg, var(--progress), rgba(33,207,178,0.85)); width:0%}

/* Stepper */
.stepper{display:flex; gap:10px; flex-wrap:wrap}
.step{display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:10px; border:1px dashed #94a3b8; background:#f8fafc; color:#0b1220}
.step.current{border-style:solid; background:rgba(33,207,178,0.10)}
.step .dot{width:10px; height:10px; border-radius:50%; background:#94a3b8; border:2px solid #cbd5e1}
.step.done .dot{background:#059669; border-color:#059669}
.step.current .dot{background:var(--progress)}

/* Forms */
.form-grid{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px}
.label{font-size:12px; color:var(--muted); margin-bottom:6px}
.input, select, textarea{
  width:100%; background:#ffffff; color:var(--text); border:1px solid var(--line); border-radius:10px; padding:10px 12px
}
.row{display:flex; gap:10px; align-items:center}
hr.sep{border:0; border-top:1px solid var(--line); margin:14px 0}

/* Utilities */
.right{margin-left:auto}
.muted{color:var(--muted)}
.small{font-size:12px}
.space-top{margin-top:10px}
.center{display:flex; align-items:center; justify-content:center}
.hidden{display:none!important}

/* Responsive */
@media (max-width:1100px){
  .app{grid-template-columns: 80px 1fr}
  .brand h1, .footer-note, .nav a .text, .nav a .tag{display:none}
  .nav a{justify-content:center}
  .search{width:70%}
}
@media (max-width:800px){
  .cards{grid-template-columns: repeat(2, 1fr)}
  .grid-2{grid-template-columns: 1fr}
  .grid-3{grid-template-columns: 1fr}
  .form-grid{grid-template-columns: 1fr}
}
</style>
</head>
<body data-page="monitoring">
  <a href="#main" class="kbd" style="position:absolute; left:-9999px; top:-9999px">Skip to content</a>
  <div class="app">
    
    <aside class="sidebar" aria-label="Sidebar Navigation">
      <div class="brand">
        <img src="Designer.png" alt="Logo" style="height:45px; width:auto; object-fit:contain; border-radius:12px; margin-bottom:8px;" />
        <h1>KYC Orchestrator</h1>
      </div>
      <nav class="nav">
        <a href="index.html" data-nav="dashboard" aria-label="Dashboard">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 12l9-9 9 9" stroke="#0b1220" stroke-width="1.5"/><path d="M5 10v10h5v-6h4v6h5V10" stroke="#0b1220" stroke-width="1.5"/></svg>
          <span class="text">Dashboard</span>
        </a>
        <a href="fund-launch.html" data-nav="fund-launch" aria-label="Fund Launch">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 19h16M7 19V7a3 3 0 0 1 3-3h4a3 3 0 0 1 3 3v12" stroke="#0b1220" stroke-width="1.5"/><path d="M9 9h6m-6 4h6" stroke="#0b1220" stroke-width="1.5"/></svg>
          <span class="text">Fund Launch</span>
          <span class="tag">Product</span>
        </a>
        <a href="distributor-onboarding.html" data-nav="distributor" aria-label="Distributor Onboarding">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M7 8h10a4 4 0 0 1 4 4v6H3v-6a4 4 0 0 1 4-4z" stroke="#0b1220" stroke-width="1.5"/><path d="M7 8V6a5 5 0 0 1 10 0v2" stroke="#0b1220" stroke-width="1.5"/></svg>
          <span class="text">Distributor Onboarding</span>
          <span class="tag">KYD</span>
        </a>
        <a href="investor-onboarding.html" data-nav="investor" aria-label="Investor Onboarding">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5z" stroke="#0b1220" stroke-width="1.5"/><path d="M3 21a9 9 0 0 1 18 0" stroke="#0b1220" stroke-width="1.5"/></svg>
          <span class="text">Investor Onboarding</span>
          <span class="tag">KYC/KYB</span>
        </a>
          <a href="Entity-mgmt.html" data-nav="entity" aria-label="Entity Management">
            <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><rect x="4" y="4" width="16" height="16" rx="3" stroke="#0b1220" stroke-width="1.5"/><path d="M8 12h8M8 16h8" stroke="#0b1220" stroke-width="1.5"/></svg>
            <span class="text">Entity Management</span>
          </a>
        <a href="asset-dd.html" data-nav="asset" aria-label="Asset & Vehicle Due Diligence">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 7h18M3 12h18M3 17h18" stroke="#0b1220" stroke-width="1.5"/><path d="M8 7v12m8-12v12" stroke="#0b1220" stroke-width="1.5"/></svg>
          <span class="text">Asset & Vehicle DD</span>
          <span class="tag">KYI</span>
        </a>
        <a href="monitoring.html" data-nav="monitoring" aria-label="Monitoring & Screening">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 13l4 4 12-12" stroke="#0b1220" stroke-width="1.5"/></svg>
          <span class="text">Monitoring & Screening</span>
          <span class="tag">KYT</span>
        </a>
        <a href="digital-trading.html" data-nav="digital" aria-label="Digital Trading">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M4 6h16v12H4z" stroke="#0b1220" stroke-width="1.5"/><path d="M8 10h8M8 14h5" stroke="#0b1220" stroke-width="1.5"/>
          </svg>
          <span class="text">Digital Trading</span>
          <span class="tag">Trades</span>
        </a>
      </nav>
      <div class="footer-note">Prototype • Static HTML • Local storage</div>
    </aside>
    
        <main class="main">
      <header class="header" role="banner">
        <div class="search" role="search" aria-label="Search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="11" cy="11" r="7" stroke="#64748b" stroke-width="1.5"/><path d="M20 20l-3-3" stroke="#64748b" stroke-width="1.5"/></svg>
          <input placeholder="Search parties, products, accounts, cases… (press / to focus)" aria-label="Global search"/>
          <span class="kbd">/</span>
        </div>
        <div class="actions">
          <button class="btn ghost" aria-label="New case">New Case</button>
          <button class="btn primary" aria-label="Add party">+ Add Party</button>
        </div>
      </header>
      <section class="content" id="main">
        <div class="page-title">
          <h2>Monitoring & Screening</h2>
          <div class="sub">Sanctions/PEP/Adverse • KYT scenarios • Case management</div>
        </div>
        
<div class="cards">
  <div class="card">
    <div class="label">Alerts Today</div>
    <div class="value">73</div>
    <div class="trend">19 open</div>
  </div>
  <div class="card">
    <div class="label">High Severity</div>
    <div class="value danger">9</div>
    <div class="trend">+2 vs yesterday</div>
  </div>
  <div class="card">
    <div class="label">Avg. Handle Time</div>
    <div class="value">17m</div>
    <div class="trend">-8%</div>
  </div>
  <div class="card">
    <div class="label">Screening Hits</div>
    <div class="value">41</div>
    <div class="trend">FPR 6.9%</div>
  </div>
  <div class="card">
    <div class="label">Transactions Reviewed</div>
    <div class="value">1,284</div>
    <div class="trend">24h</div>
  </div>
  <div class="card">
    <div class="label">SAR/STR Filed (Mtd)</div>
    <div class="value">3</div>
    <div class="trend">—</div>
  </div>
</div>

<div class="grid-2">
  <div class="section">
    <h3>Alert Queue</h3>
    <div class="row small">
      <label>Filter:</label>
      <select id="filterSel">
        <option value="all">All</option>
        <option value="sanctions">Sanctions</option>
        <option value="pep">PEP</option>
        <option value="adverse">Adverse Media</option>
        <option value="txn">Transaction</option>
      </select>
    </div>
    <table class="table" id="alertTable">
      <thead><tr><th>ID</th><th>Type</th><th>Party</th><th>Severity</th><th>Age</th><th>Status</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="section">
    <h3>Case Panel</h3>
    <div id="casePanel" class="small muted">Select an alert to view details.</div>
  </div>
</div>

<script>
(() => {
  const alerts = [
    {id:'A-2001', type:'sanctions', party:'Riverton Capital SICAV', sev:'high', age:'2h', status:'Open', detail:'Name match vs OFAC SDN (fuzzy)'},
    {id:'A-2002', type:'txn', party:'Txn T-998210', sev:'high', age:'1h', status:'Escalated', detail:'Rapid in/out pattern (structuring)'},
    {id:'A-2003', type:'pep', party:'Alpha Distrib GmbH', sev:'med', age:'30m', status:'Open', detail:'PEP associate match'},
    {id:'A-2004', type:'adverse', party:'Solaris Bank AG', sev:'low', age:'10m', status:'Open', detail:'Low severity article'},
    {id:'A-2005', type:'txn', party:'Txn T-998301', sev:'med', age:'3h', status:'Open', detail:'Geo risk: sanctioned corridor'},
    {id:'A-2006', type:'sanctions', party:'Northshore GP', sev:'low', age:'8m', status:'Closed', detail:'False positive auto-closed'}
  ];
  const tbody = document.querySelector('#alertTable tbody');
  const panel = document.getElementById('casePanel');
  const render = (flt='all') => {
    tbody.innerHTML = alerts.filter(a => flt==='all' || a.type===flt).map(a => `
      <tr data-id="${a.id}" style="cursor:pointer">
        <td>${a.id}</td>
        <td>${a.type}</td>
        <td>${a.party}</td>
        <td>${a.sev==='high' ? '<span class="badge danger">High</span>' : (a.sev==='med' ? '<span class="badge warn">Medium</span>' : '<span class="badge">Low</span>')}</td>
        <td>${a.age}</td>
        <td><span class="badge">${a.status}</span></td>
      </tr>`).join('');
    tbody.querySelectorAll('tr').forEach(tr => tr.addEventListener('click', () => {
      const id = tr.getAttribute('data-id');
      const a = alerts.find(x => x.id===id);
      panel.innerHTML = `
        <div class="row"><span class="badge info">Alert</span> ${a.id}</div>
        <div class="row small space-top"><div style="width:120px">Type</div><div>${a.type}</div></div>
        <div class="row small"><div style="width:120px">Party</div><div>${a.party}</div></div>
        <div class="row small"><div style="width:120px">Severity</div><div>${a.sev}</div></div>
        <hr class="sep"/>
        <div class="small">${a.detail}</div>
        <hr class="sep"/>
        <div class="row">
          <button class="btn">Assign</button>
          <button class="btn ghost">Escalate</button>
          <button class="btn ghost">Close</button>
        </div>
      `;
    }));
  };
  render();
  document.getElementById('filterSel').addEventListener('change', (e)=>render(e.target.value));
})();
</script>

      
<!-- Monitoring Controls & KPIs -->
<div class="cards" id="monKpis">
  <div class="card"><div class="label">Trades in Period</div><div class="value" id="kpiTrades">0</div></div>
  <div class="card"><div class="label">Total Value</div><div class="value" id="kpiValue">$0</div></div>
  <div class="card"><div class="label">Investors Flagged</div><div class="value" id="kpiFlagged">0</div></div>
  <div class="card"><div class="label">Blocked Attempts</div><div class="value" id="kpiBlocked">0</div></div>
  <div class="card"><div class="label">Post-Amendment Reds</div><div class="value" id="kpiPostAmend">0</div></div>
  <div class="card"><div class="label">Countries In Scope</div><div class="value" id="kpiCountries">0</div></div>
</div>

<div class="section" id="monControls">
  <h3>Rules & Thresholds</h3>
  <div class="form-grid">
    <div>
      <div class="label">Reporting Period</div>
      <select id="periodSel">
        <option value="7">Last 7 days</option>
        <option value="30" selected>Last 30 days</option>
        <option value="90">Last 90 days</option>
        <option value="180">Last 180 days</option>
        <option value="custom">Custom range</option>
      </select>
    </div>
    <div>
      <div class="label">Custom: From</div>
      <input type="date" id="fromDate" class="input"/>
    </div>
    <div>
      <div class="label">Custom: To</div>
      <input type="date" id="toDate" class="input"/>
    </div>
    <div>
      <div class="label">Country Filter</div>
      <select id="countryFilter"><option value="all">All Countries</option></select>
    </div>
    <div>
      <div class="label"># Trades threshold (per investor)</div>
      <input id="thCount" class="input" type="number" value="4"/>
    </div>
    <div>
      <div class="label">Value threshold (per investor, base ccy)</div>
      <input id="thValue" class="input" type="number" value="500000"/>
    </div>
    <div>
      <div class="label">Value vs Balance ratio</div>
      <input id="thRatio" class="input" type="number" step="0.1" value="1.0"/>
    </div>
    <div>
      <div class="label">Post-amendment window (days)</div>
      <input id="thAmendDays" class="input" type="number" value="30"/>
    </div>
  </div>
  <div class="row space-top">
    <button class="btn primary" id="runBtn">Run Scenarios</button>
    <button class="btn ghost" id="seedBtn">Load Sample Data</button>
  </div>
</div>

<div class="section" id="alertsSection">
  <h3>Scenario Alerts</h3>
  <table class="table" id="alertsTable">
    <thead>
      <tr>
        <th>Investor</th><th>Country</th><th>Trades</th><th>Value</th><th>Balance</th><th>Value/Balance</th><th>Blocked?</th><th>Post‑Amend Red?</th><th>Triggered Rules</th><th>Last Trade</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="small muted">Rules: Count, Value, Ratio, Blocked, Post-Amend. Click a row to view investor detail & trades.</div>
</div>

<div class="section" id="ledgerSection">
  <h3 style="cursor:pointer; user-select:none" id="ledgerToggle">
    <span id="ledgerArrow" style="display:inline-block; transition:transform 0.2s;">&#9654;</span> Trade Ledger (in period)
  </h3>
  <div id="ledgerContent" style="display:none;">
    <table class="table" id="ledgerTable">
      <thead>
        <tr><th>Date</th><th>Trade ID</th><th>Investor</th><th>Type</th><th>Amount</th><th>Allowed?</th><th>Outcome</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Detail Modal -->
<div id="monModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="Monitoring details">
  <div class="box">
    <h4 id="monModalTitle">Investor Details</h4>
    <div id="monModalBody" class="small"></div>
    <div class="actions"><button class="btn" id="monModalClose">Close</button></div>
  </div>
</div>
</section>
    </main>
  </div>
  <script>
(() => {
  const body = document.body;
  const page = body.getAttribute('data-page');
  // Activate nav
  document.querySelectorAll('.nav a').forEach(a => { if (a.dataset.nav === page) a.classList.add('active'); });
  // Animate progress
  const animate = () => {
    document.querySelectorAll('.progress > span[data-value]').forEach(el => {
      const v = parseInt(el.getAttribute('data-value'),10) || 0;
      el.style.width = '0%';
      setTimeout(() => el.style.width = v + '%', 120);
    });
  };
  animate();
  // "/" shortcut to focus search
  window.addEventListener('keydown', (e) => {
    if (e.key === '/' && !/input|textarea|select/i.test(document.activeElement.tagName)) {
      const i = document.querySelector('.search input'); if (i) { e.preventDefault(); i.focus(); }
    }
  });
})();
document.getElementById('ledgerToggle').addEventListener('click', function() {
  var content = document.getElementById('ledgerContent');
  var arrow = document.getElementById('ledgerArrow');
  var isCollapsed = content.style.display === 'none';
  content.style.display = isCollapsed ? '' : 'none';
  arrow.style.transform = isCollapsed ? 'rotate(90deg)' : 'rotate(0deg)';
});
</script>
  
<script>

(() => {
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
  const fmtTS = (ts) => ts ? new Date(ts).toLocaleString() : '—';
  const fmtD = (ts) => ts ? new Date(ts).toISOString().slice(0,10) : '—';
  const fmtC = (n) => (n||0).toLocaleString(undefined, {style:'currency', currency:'USD', maximumFractionDigits:0});

  const ACC_KEY = 'kmt_accounts';
  const TRD_KEY = 'kmt_trades';

  const read = (k) => { try { return JSON.parse(localStorage.getItem(k) || '[]'); } catch(e){ return []; } };
  const write = (k, v) => localStorage.setItem(k, JSON.stringify(v));

  // --- Sample data seeding (if none) ---
  const seed = () => {
    let acc = read(ACC_KEY);
    let trd = read(TRD_KEY);
    if (acc.length && trd.length) return;
    const now = Date.now(), d = (n)=> now - 86400000*n;
    acc = [
      {id:'INV-1001', name:'Riverton Capital SICAV', country:'FR', balance: 900000, blockType:'none', allowTypes:['subscription','redemption'], staticAmend: d(40)},
      {id:'INV-1002', name:'Arcturus Family Office', country:'ES', balance: 250000, blockType:'soft', allowTypes:['subscription'], staticAmend: d(12)},
      {id:'INV-1003', name:'Blue Cove Partners LLP', country:'GB', balance: 1200000, blockType:'hard', allowTypes:[], staticAmend: d(5)},
      {id:'INV-1004', name:'Solaris Bank AG', country:'DE', balance: 180000, blockType:'none', allowTypes:['subscription','redemption'], staticAmend: d(100)},
      {id:'INV-1005', name:'Tawny Holdings Ltd', country:'MT', balance: 80000, blockType:'none', allowTypes:['subscription','redemption'], staticAmend: d(2)},
    ];
    trd = [
      {id:'T-90001', investorId:'INV-1001', date:d(14), type:'subscription', amount:180000, status:'booked'},
      {id:'T-90002', investorId:'INV-1001', date:d(7), type:'subscription', amount:220000, status:'booked'},
      {id:'T-90003', investorId:'INV-1001', date:d(4), type:'redemption', amount:100000, status:'booked'},

      {id:'T-90011', investorId:'INV-1002', date:d(10), type:'redemption', amount:150000, status:'booked'}, // soft block -> violation
      {id:'T-90012', investorId:'INV-1002', date:d(6), type:'subscription', amount:120000, status:'booked'},

      {id:'T-90021', investorId:'INV-1003', date:d(3), type:'subscription', amount:50000, status:'rejected'}, // hard block
      {id:'T-90022', investorId:'INV-1003', date:d(1), type:'redemption', amount:20000, status:'rejected'},

      {id:'T-90031', investorId:'INV-1004', date:d(20), type:'subscription', amount:30000, status:'booked'},
      {id:'T-90032', investorId:'INV-1004', date:d(12), type:'redemption', amount:20000, status:'booked'},

      {id:'T-90041', investorId:'INV-1005', date:d(1), type:'redemption', amount:50000, status:'booked'}, // within 30d of static amend
      {id:'T-90042', investorId:'INV-1005', date:d(0), type:'subscription', amount:90000, status:'booked'},
    ];
    write(ACC_KEY, acc); write(TRD_KEY, trd);
  };

  const inPeriod = (ts, start, end) => ts>=start && ts<=end;

  // --- Controls
  const periodSel = $('#periodSel');
  const fromDate = $('#fromDate');
  const toDate = $('#toDate');
  const country = $('#countryFilter');
  const thCount = $('#thCount');
  const thValue = $('#thValue');
  const thRatio = $('#thRatio');
  const thAmend = $('#thAmendDays');

  const kTrades = $('#kpiTrades'), kVal = $('#kpiValue'), kFlag = $('#kpiFlagged'), kBlocked = $('#kpiBlocked'), kPost = $('#kpiPostAmend'), kCtry = $('#kpiCountries');

  const alertsBody = $('#alertsTable tbody');
  const ledgerBody = $('#ledgerTable tbody');

  const modal = $('#monModal'), modalTitle = $('#monModalTitle'), modalBody = $('#monModalBody');
  const openModal = (title, html) => { modalTitle.textContent = title; modalBody.innerHTML = html; modal.classList.remove('hidden'); };
  $('#monModalClose').addEventListener('click', () => modal.classList.add('hidden'));
  modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.add('hidden'); });

  // Build country filter options
  const refreshCountries = (accounts) => {
    const set = new Set(accounts.map(a => a.country||'??'));
    country.innerHTML = '<option value="all">All Countries</option>' + Array.from(set).sort().map(c => `<option value="${c}">${c}</option>`).join('');
  };

  const getPeriod = () => {
    const now = new Date();
    if (periodSel.value !== 'custom') {
      const days = parseInt(periodSel.value, 10);
      const end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59).getTime();
      const start = end - (days*86400000);
      return {start, end};
    } else {
      const s = new Date(fromDate.value + 'T00:00:00').getTime();
      const e = new Date(toDate.value + 'T23:59:59').getTime();
      return {start: s||0, end: e||Date.now()};
    }
  };

  const allowedByBlock = (acc, type) => {
    if (!acc || acc.blockType === 'none') return true;
    if (acc.blockType === 'hard') return false;
    // soft block: allow only allowed types
    return (acc.allowTypes||[]).includes(type);
  };

  const run = () => {
    const accounts = read(ACC_KEY);
    const trades = read(TRD_KEY);
    refreshCountries(accounts);

    const {start, end} = getPeriod();

    // Filter trades by period and country
    const byId = new Map(accounts.map(a => [a.id, a]));
    const tradesInPeriod = trades.filter(t => inPeriod(t.date, start, end))
      .filter(t => country.value === 'all' ? true : (byId.get(t.investorId)?.country === country.value));

    // KPI: Trades & Value
    kTrades.textContent = tradesInPeriod.length.toString();
    const totalVal = tradesInPeriod.reduce((a,t)=> a + (t.amount||0), 0);
    kVal.textContent = fmtC(totalVal);
    kCtry.textContent = new Set(tradesInPeriod.map(t => byId.get(t.investorId)?.country||'??')).size;

    // Aggregate per investor
    const perInv = new Map();
    tradesInPeriod.forEach(t => {
      const acc = byId.get(t.investorId);
      if (!perInv.has(t.investorId)) perInv.set(t.investorId, {acc, trades:[], sum:0, reds:[], violations:[], last:0});
      const p = perInv.get(t.investorId);
      p.trades.push(t);
      p.sum += t.amount||0;
      p.last = Math.max(p.last, t.date||0);
      if (t.type === 'redemption') p.reds.push(t);
      if (!allowedByBlock(acc, t.type)) p.violations.push(t);
    });

    // Build alerts
    const countTh = parseInt(thCount.value||'0',10);
    const valueTh = parseFloat(thValue.value||'0');
    const ratioTh = parseFloat(thRatio.value||'1');
    const amendDays = parseInt(thAmend.value||'30',10);

    let flaggedRows = [];
    let blockedAttempts = 0;
    let postAmendFlagCount = 0;

    perInv.forEach((p, invId) => {
      const acc = p.acc || {};
      const n = p.trades.length;
      const sum = p.sum;
      const bal = acc.balance || 0;
      const ratio = bal>0 ? sum/bal : (sum>0 ? Infinity : 0);
      const rules = [];
      if (n > countTh) rules.push('Count');
      if (sum > valueTh) rules.push('Value');
      if (ratio > ratioTh) rules.push('Ratio');
      const blocked = p.violations.length>0;
      if (blocked) { rules.push('Blocked'); blockedAttempts += p.violations.length; }
      // Post-amend redemptions
      const wnd = amendDays*86400000;
      const postAmend = p.reds.some(r => (r.date - (acc.staticAmend||0)) <= wnd);
      if (postAmend) { rules.push('Post-Amend'); postAmendFlagCount++; }
      if (rules.length) {
        flaggedRows.push({
          invId, name: acc.name||invId, country: acc.country||'—', n, sum, bal, ratio,
          blocked, postAmend, rules, last: p.last, trades: p.trades
        });
      }
    });

    kFlag.textContent = flaggedRows.length.toString();
    kBlocked.textContent = String(blockedAttempts);
    kPost.textContent = String(postAmendFlagCount);

    alertsBody.innerHTML = flaggedRows.map(r => `
      <tr data-id="${r.invId}" style="cursor:pointer">
        <td>${r.name} <span class="muted">(${r.invId})</span></td>
        <td>${r.country}</td>
        <td>${r.n}</td>
        <td>${fmtC(r.sum)}</td>
        <td>${fmtC(r.bal)}</td>
        <td>${r.ratio===Infinity?'∞':r.ratio.toFixed(2)}</td>
        <td>${r.blocked ? '<span class="badge danger">Yes</span>' : '<span class="badge ok">No</span>'}</td>
        <td>${r.postAmend ? '<span class="badge warn">Yes</span>' : '<span class="badge ok">No</span>'}</td>
        <td>${r.rules.join(', ')}</td>
        <td>${fmtTS(r.last)}</td>
      </tr>
    `).join('');

    // Wire row click -> modal
    $$('#alertsTable tbody tr').forEach(tr => tr.addEventListener('click', () => {
      const id = tr.getAttribute('data-id');
      const row = flaggedRows.find(x => x.invId === id); if (!row) return;
      // Mini timeline
      const acc = row; const accounts = byId;
      const a = accounts.get(id);
      const tlSteps = [
        {label:'Static Amended', ts: a?.staticAmend||null},
        {label:'Blocked Set', ts: (a?.blockType && a.blockType!=='none') ? (a.staticAmend ? a.staticAmend + 3600000 : null) : null},
        {label:'Trades', ts: row.last||null},
        {label:'Alert', ts: Date.now()}
      ];
      const tlHtml = tlSteps.map((s,i)=>`
        <div class="tl-step ${s.ts?'done':'pending'}">
          <div class="tl-dot"></div>
          <div class="tl-label">${s.label}</div>
          <div class="tl-time">${s.ts?fmtTS(s.ts):'—'}</div>
        </div>${i<tlSteps.length-1?'<div class="tl-line"></div>':''}
      `).join('');

      const list = row.trades.map(t => `<tr><td>${fmtD(t.date)}</td><td>${t.id}</td><td>${t.type}</td><td>${fmtC(t.amount)}</td><td>${allowedByBlock(a,t.type)?'Allowed':'Blocked'}</td><td>${t.status||'—'}</td></tr>`).join('');

      openModal(`Investor ${a?.name||id}`, `
        <div class="row small"><div style="width:160px">Investor ID</div><div>${id}</div></div>
        <div class="row small"><div style="width:160px">Country</div><div>${a?.country||'—'}</div></div>
        <div class="row small"><div style="width:160px">Balance</div><div>${fmtC(a?.balance||0)}</div></div>
        <div class="row small"><div style="width:160px">Block Type</div><div>${(a?.blockType||'none').toUpperCase()}</div></div>
        <div class="row small"><div style="width:160px">Static Data Amended</div><div>${fmtTS(a?.staticAmend||null)}</div></div>
        <hr class="sep"/>
        <div class="small"><b>Timeline</b></div>
        <div class="timeline">${tlHtml}</div>
        <hr class="sep"/>
        <div class="small"><b>Trades in period</b></div>
        <table class="table small"><thead><tr><th>Date</th><th>Trade ID</th><th>Type</th><th>Amount</th><th>Allowed?</th><th>Outcome</th></tr></thead><tbody>${list}</tbody></table>
      `);
    }));

    // Ledger
    ledgerBody.innerHTML = tradesInPeriod.map(t => {
      const acc = byId.get(t.investorId);
      const allowed = allowedByBlock(acc, t.type);
      return `<tr>
        <td>${fmtD(t.date)}</td><td>${t.id}</td>
        <td>${acc?.name||t.investorId}</td>
        <td>${t.type}</td><td>${fmtC(t.amount)}</td><td>${allowed?'<span class="badge ok">Yes</span>':'<span class="badge danger">No</span>'}</td><td>${t.status||'—'}</td>
      </tr>`;
    }).join('');
  };

  // Bind controls
  $('#runBtn').addEventListener('click', run);
  $('#seedBtn').addEventListener('click', () => { localStorage.removeItem(ACC_KEY); localStorage.removeItem(TRD_KEY); seed(); run(); });
  periodSel.addEventListener('change', () => {
    const custom = periodSel.value === 'custom';
    fromDate.disabled = !custom; toDate.disabled = !custom;
  });

  // Initialize
  seed();
  run();
})();

</script>
</body>
</html>