<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Digital Trading · KYC Orchestrator</title>
  <style>
  :root{
    --sidebar-bg: #f7fafd;
    --sidebar-icon: #4976a4;
    --sidebar-text: #4976a4;
    --sidebar-width: 80px;
    --sidebar-font-size: 12px;
    --sidebar-title-size: 13px;
    --sidebar-tag-size: 10px;
    --sidebar-icon-size: 28px;
    --sidebar-active: #e3eefa;
    --sidebar-width: 170px;
    --sidebar-font-size: 11px;
    --sidebar-title-size: 13px;
    --sidebar-tag-size: 10px;
    --sidebar-icon-size: 18px;
    --page:#ffffff;
    --text:#0f172a;
    --muted:#475569;
    --line:#e5e7eb;
    --card:#ffffff;
    --sidebar: rgba(33,207,178,0.20);
    --btn: rgba(33,207,178,0.60);
    --btn-border: rgba(33,207,178,0.60);
    --btn-text:#0b1220;
    --link:#0ea5e9;
    --task:#a399ff;
    --success:#059669;
    --warn:#d97706;
    --danger:#dc2626;
    --info:#2563eb;
    --progress:#21cfb2;
  }
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial;
  background: var(--page);
  color:var(--text);
  line-height:1.45;
}
a{color:var(--link); text-decoration:none}
a:hover{text-decoration:underline}

/* Layout */

.app{display:grid; grid-template-columns: var(--sidebar-width) 1fr; min-height:100vh}
.sidebar {
  background: var(--sidebar-bg);
  border-right: 1px solid var(--line);
  width: var(--sidebar-width);
  min-width: var(--sidebar-width);
  max-width: var(--sidebar-width);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  height: 100vh;
  padding: 0;
}
.sidebar .brand {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 24px 0 0 0;
}
.sidebar .logo {
  width: 36px;
  height: 36px;
  border-radius: 12px;
  background: radial-gradient(circle at 25% 20%, #4976a4 0%, #e3eefa 100%);
  margin-bottom: 8px;
}
.sidebar .brand h1 {
  font-size: 14px;
  color: var(--sidebar-text);
  margin: 0;
  font-weight: 600;
  letter-spacing: 0.2px;
}
.sidebar .nav {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 28px;
  margin-top: 24px;
}
.sidebar .nav a {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  color: var(--sidebar-text);
  text-decoration: none;
  font-size: var(--sidebar-font-size);
  padding: 0;
  border-radius: 8px;
  width: 100%;
  transition: background 0.15s;
}
.sidebar .nav a.active, .sidebar .nav a:hover {
  background: var(--sidebar-active);
}
.sidebar .nav .icon {
  width: var(--sidebar-icon-size);
  height: var(--sidebar-icon-size);
  color: var(--sidebar-icon);
  display: block;
}
.sidebar .nav .text {
  font-size: var(--sidebar-font-size);
  color: var(--sidebar-text);
  text-align: center;
  margin-top: 2px;
}
.sidebar .nav .tag {
  display: none;
}
.sidebar .footer-note {
  margin-top: 10px;
  font-size: 10px;
  color: var(--muted);
  opacity: .85;
  padding: 0 3px;
  margin-bottom: 18px;
}

/* Top bar */
.header{
  display:flex; align-items:center; justify-content:space-between;
  padding:16px 22px; position:sticky; top:0; z-index:5;
  background:rgba(255,255,255,0.9);
  backdrop-filter: blur(6px);
  border-bottom: 1px solid var(--line);
}
.search{
  display:flex; align-items:center; gap:8px; border:1px solid var(--line);
  background: var(--card);
  padding:10px 12px; border-radius:12px; width:52%;
}
.search input{
  flex:1; background:transparent; border:none; outline:none; color:var(--text);
}
.actions{display:flex; align-items:center; gap:10px}
.btn{
  background: var(--btn);
  border:1px solid var(--btn-border);
  color:var(--btn-text); padding:10px 12px; border-radius:10px; cursor:pointer;
  transition: filter .15s ease, transform .02s ease;
}
.btn:hover{filter:brightness(1.05)}
.btn:active{transform:translateY(1px)}
.btn.primary{background: var(--btn); border-color: var(--btn-border)}
.btn.ghost{background:transparent; color: var(--btn-text); border-color: var(--btn-border)}
.btn.small{padding:6px 10px; font-size:12px}
.kbd{font: 12px/1.6 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; padding:2px 6px; border-radius:6px; border:1px solid var(--line); color:var(--muted)}

/* Content */
.content{padding:14px 22px 40px}
.page-title{display:flex; align-items:baseline; justify-content:space-between; gap:12px; margin:12px 0 8px 0}
.page-title h2{margin:0; font-size:22px}
.page-title .sub{color:var(--muted)}

/* Cards & sections */
.cards{display:grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap:14px; margin:14px 0 6px}
.card{
  background: var(--card);
  border:1px solid var(--line); border-radius:14px; padding:12px 14px; min-height:72px;
  box-shadow: 0 8px 28px rgba(2,6,23,.06);
}
.card .label{color:var(--muted); font-size:12px}
.card .value{font-size:22px; margin-top:2px}
.card .trend{font-size:12px; color:#047857}
.card .danger{color:var(--danger)}

.grid-2{display:grid; grid-template-columns: 2fr 1fr; gap:16px; margin-top:16px}
.grid-3{display:grid; grid-template-columns: repeat(3, 1fr); gap:16px; margin-top:16px}
.section{background: var(--card); border:1px solid var(--line); border-radius:14px; padding:16px}
.section h3{margin:0 0 10px 0; font-size:16px}

/* Table */
.table{width:100%; border-collapse:separate; border-spacing:0 8px; font-size:14px}
.table th{color:var(--muted); text-align:left; font-weight:600; padding:8px 10px; border-bottom:1px solid var(--line)}
.table td{padding:10px; background:#ffffff; border:1px solid var(--line)}
.table tr td:first-child{border-top-left-radius:10px; border-bottom-left-radius:10px}
.table tr td:last-child{border-top-right-radius:10px; border-bottom-right-radius:10px}

/* Badges & pills */
.badge{font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--line); background:#f8fafc; color:#0b1220}
.badge.ok{border-color:#065f46; background:#ecfdf5; color:#065f46}
.badge.warn{border-color:#92400e; background:#fffbeb; color:#92400e}
.badge.danger{border-color:#7f1d1d; background:#fef2f2; color:#7f1d1d}
.badge.info{border-color:#1e3a8a; background:#eff6ff; color:#1e3a8a}
/* Action task badge in requested color */
.badge.task{border-color:#6f63ff; background:#a399ff; color:#ffffff}

.pills{display:flex; gap:8px; flex-wrap:wrap}
.pill{padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:#f8fafc; cursor:pointer; font-size:12px; color:#0b1220}
.pill.active{background:rgba(33,207,178,0.18); border-color:rgba(33,207,178,0.28)}

/* Progress */
.progress{width:100%; height:10px; border-radius:999px; background:#f1f5f9; border:1px solid var(--line); overflow:hidden}
.progress > span{display:block; height:100%; background:linear-gradient(90deg, var(--progress), rgba(33,207,178,0.85)); width:0%}

/* Stepper */
.stepper{display:flex; gap:10px; flex-wrap:wrap}
        .step{
          display:flex; align-items:center; gap:6px; padding:4px 8px; border-radius:7px; border:1px solid #b6b6b6;
          background:#f8fafc; color:#0b1220; font-size:11px; min-width:70px;
          transition: background 0.2s, color 0.2s;
        }
        .step .dot{width:7px; height:7px; border-radius:50%; background:#94a3b8; border:1px solid #cbd5e1}
        .step.done{
          background:#e0e7ff; color:#1e3a8a; border-color:#3b82f6;
        }
        .step.done .dot{background:#3b82f6; border-color:#3b82f6;}
        .step.next{
          background:#dcfce7; color:#065f46; border-color:#22c55e;
        }
        .step.next .dot{background:#22c55e; border-color:#22c55e;}
        .step.notstarted{
          background:#fff7ed; color:#92400e; border-color:#fbbf24;
        }
        .step.notstarted .dot{background:#fbbf24; border-color:#fbbf24;}

/* Forms */
.form-grid{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px}
.label{font-size:12px; color:var(--muted); margin-bottom:6px}
.input, select, textarea{
  width:100%; background:#ffffff; color:var(--text); border:1px solid var(--line); border-radius:10px; padding:10px 12px
}
.row{display:flex; gap:10px; align-items:center}
hr.sep{border:0; border-top:1px solid var(--line); margin:14px 0}

/* Utilities */
.right{margin-left:auto}
.muted{color:var(--muted)}
.small{font-size:12px}
.space-top{margin-top:10px}
.center{display:flex; align-items:center; justify-content:center}
.hidden{display:none!important}

/* Responsive */
@media (max-width:1100px){
  .app{grid-template-columns: 80px 1fr}
  .brand h1, .footer-note, .nav a .text, .nav a .tag{display:none}
  .nav a{justify-content:center}
  .search{width:70%}
}
@media (max-width:800px){
  .cards{grid-template-columns: repeat(2, 1fr)}
  .grid-2{grid-template-columns: 1fr}
  .grid-3{grid-template-columns: 1fr}
  .form-grid{grid-template-columns: 1fr}
}
</style>
</head>
<body data-page="digital">
  <a href="#main" class="kbd" style="position:absolute; left:-9999px; top:-9999px">Skip to content</a>
  <div class="app">
    
    <aside class="sidebar" aria-label="Sidebar Navigation">
      <div class="brand">
        <img src="Designer.png" alt="Logo" style="height:45px; width:auto; object-fit:contain; border-radius:12px; margin-bottom:8px;" />
        <h1>KYC Orchestrator</h1>
      </div>
      <nav class="nav">
        <a href="index.html" data-nav="dashboard" aria-label="Dashboard">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 12l9-9 9 9" stroke="#0b1220" stroke-width="1.5"/><path d="M5 10v10h5v-6h4v6h5V10" stroke="#0b1220" stroke-width="1.5"/></svg>
          <span class="text">Dashboard</span>
        </a>
        <a href="fund-launch.html" data-nav="fund-launch" aria-label="Fund Launch">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 19h16M7 19V7a3 3 0 0 1 3-3h4a3 3 0 0 1 3 3v12" stroke="#0b1220" stroke-width="1.5"/><path d="M9 9h6m-6 4h6" stroke="#0b1220" stroke-width="1.5"/></svg>
          <span class="text">Fund Launch</span>
          <span class="tag">Product</span>
        </a>
        <a href="distributor-onboarding.html" data-nav="distributor" aria-label="Distributor Onboarding">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M7 8h10a4 4 0 0 1 4 4v6H3v-6a4 4 0 0 1 4-4z" stroke="#0b1220" stroke-width="1.5"/><path d="M7 8V6a5 5 0 0 1 10 0v2" stroke="#0b1220" stroke-width="1.5"/></svg>
          <span class="text">Distributor Onboarding</span>
          <span class="tag">KYD</span>
        </a>
        <a href="investor-onboarding.html" data-nav="investor" aria-label="Investor Onboarding">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5z" stroke="#0b1220" stroke-width="1.5"/><path d="M3 21a9 9 0 0 1 18 0" stroke="#0b1220" stroke-width="1.5"/></svg>
          <span class="text">Investor Onboarding</span>
          <span class="tag">KYC/KYB</span>
        </a>
          <a href="Entity-mgmt.html" data-nav="entity" aria-label="Entity Management">
            <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><rect x="4" y="4" width="16" height="16" rx="3" stroke="#0b1220" stroke-width="1.5"/><path d="M8 12h8M8 16h8" stroke="#0b1220" stroke-width="1.5"/></svg>
            <span class="text">Entity Management</span>
          </a>
        <a href="asset-dd.html" data-nav="asset" aria-label="Asset & Vehicle Due Diligence">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 7h18M3 12h18M3 17h18" stroke="#0b1220" stroke-width="1.5"/><path d="M8 7v12m8-12v12" stroke="#0b1220" stroke-width="1.5"/></svg>
          <span class="text">Asset & Vehicle DD</span>
          <span class="tag">KYI</span>
        </a>
        <a href="monitoring.html" data-nav="monitoring" aria-label="Monitoring & Screening">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 13l4 4 12-12" stroke="#0b1220" stroke-width="1.5"/></svg>
          <span class="text">Monitoring & Screening</span>
          <span class="tag">KYT</span>
        </a>
        <a href="digital-trading.html" data-nav="digital" aria-label="Digital Trading">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M4 6h16v12H4z" stroke="#0b1220" stroke-width="1.5"/><path d="M8 10h8M8 14h5" stroke="#0b1220" stroke-width="1.5"/>
          </svg>
          <span class="text">Digital Trading</span>
          <span class="tag">Trades</span>
        </a>
      </nav>
      <div class="footer-note">Prototype • Static HTML • Local storage</div>
    </aside>
    
    <main class="main">
      <header class="header" role="banner">
        <div class="search" role="search" aria-label="Search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="11" cy="11" r="7" stroke="#64748b" stroke-width="1.5"/><path d="M20 20l-3-3" stroke="#64748b" stroke-width="1.5"/></svg>
          <input placeholder="Search parties, products, accounts, cases… (press / to focus)" aria-label="Global search"/>
          <span class="kbd">/</span>
        </div>
        <div class="actions">
          <button class="btn ghost" aria-label="New case">New Case</button>
          <button class="btn primary" aria-label="Add party">+ Add Party</button>
        </div>
      </header>
      <section class="content" id="main">
        <div class="page-title">
          <h2>Digital Trading</h2>
          <div class="sub">Create/upload T&Cs • Data tags • Workflow • Investor invitations • Blueprint</div>
        </div>
        
<div class="grid-2">
  <div class="section">
    <div class="row">
      <h3>My Fund Portfolio</h3>
      <div class="right">
        <button class="btn small" id="newTradeBtn">+ New Trade Document</button>
      </div>
    </div>
    <div class="row space-top">
      <div class="pills" id="tradeFilters">
        <span class="pill active" data-f="all">All</span>
        <span class="pill" data-f="open">Open</span>
        <span class="pill" data-f="closed">Closed</span>
      </div>
      <div class="right row">
        <input class="input" id="openById" placeholder="Enter Fund ID e.g., DT-0001" style="width:240px"/>
        <button class="btn small" id="openByIdBtn">Open</button>
      </div>
    </div>
    <div class="row" style="margin-bottom:8px">
      <button class="btn danger small" id="bulkDeleteBtn" style="display:none">Delete Selected</button>
    </div>
    <table class="table space-top" id="tradesTable">
      <thead><tr>
        <th><input type="checkbox" id="selectAllTrades"/></th>
        <th>ID</th><th>Name</th><th>Stage</th><th>Accepted</th><th>Onboarding</th><th>Invested</th><th>Updated</th>
      </tr></thead>
      <tbody></tbody>
    </table>
    <div class="small muted">Click a row to open the trade document builder. “Open” = not archived; “Closed” = marked Live & Closed.</div>
  </div>

  <div class="section">
    <h3>Trade Document Builder</h3>
    <div id="noTrade" class="small muted">Select a trade from the left or create a new one.</div>
    <div id="tradePanel" class="hidden">
      <div class="row"><span class="badge info">Trade ID</span> <strong id="tId">—</strong><div class="right small muted">Updated <span id="tUpdated">—</span></div></div>
      <div class="space-top stepper">
        <div class="step" data-s="created"><div class="dot"></div> Created</div>
        <div class="step" data-s="legal"><div class="dot"></div> Legal Review</div>
        <div class="step" data-s="im"><div class="dot"></div> IM Approval</div>
        <div class="step" data-s="blueprint"><div class="dot"></div> Blueprint</div>
        <div class="step" data-s="invite"><div class="dot"></div> Investor Invitations</div>
        <div class="step" data-s="live"><div class="dot"></div> Live</div>
      </div>

      <hr class="sep"/>
      <h3>Workflow</h3>
      <div class="row">
        <button class="btn small" id="toLegalBtn">Send to Legal</button>
        <button class="btn small" id="toIMBtn">IM Approve</button>
        <button class="btn small" id="toBlueprintBtn">To Blueprint</button>
        <button class="btn small" id="toInviteBtn">Invite Investors</button>
        <button class="btn small" id="markLiveBtn">Mark Live & Close</button>
        <div class="right">
          <button class="btn ghost small" id="editBtn">Edit</button>
          <button class="btn danger small hidden" id="deleteBtn">Delete</button>
          <button class="btn primary small" id="saveBtn">Save Trade Document</button>
        </div>
      </div>
      <hr class="sep"/>
      <h3>Digital Trade Setup</h3>
      <div class="form-grid">
        <div><div class="label">Fund Name</div><input class="input" id="tName" placeholder="e.g., Sustainable Credit A — Oct 2025"/></div>
        <div><div class="label">Closing Date</div><input class="input" id="tClose" placeholder="YYYY-MM-DD"/></div>
        <div style="grid-column: 1 / -1"><div class="label">T&Cs (paste text or load file)</div>
          <textarea id="tTerms" rows="6" placeholder="Enter legal terms and conditions... Use {{placeholders}} to indicate data tags."></textarea>
          <div class="row space-top">
            <input type="file" id="termsFile" class="input" style="padding:8px"/>
            <button class="btn small" id="loadTermsBtn">Load File</button>
            <div class="small muted">Plain text files recommended in this prototype.</div>
          </div>
        </div>
      </div>

      <hr class="sep"/>
      <h3>Data Tags</h3>
      <div class="form-grid">
        <div><div class="label">Tag Name</div><input class="input" id="tagName" placeholder="e.g., amount"/></div>
        <div><div class="label">Type</div>
          <select id="tagType">
            <option value="text">Text</option>
            <option value="number">Number</option>
            <option value="date">Date</option>
            <option value="dropdown">Dropdown</option>
          </select>
        </div>
        <div><div class="label">Required?</div><select id="tagReq"><option value="true">Yes</option><option value="false">No</option></select></div>
        <div id="optsWrap"><div class="label">Options (comma separated)</div><input class="input" id="tagOpts" placeholder="e.g., USD,EUR,GBP"/></div>
      </div>
      <div class="row space-top">
        <button class="btn small" id="addTagBtn">Add Tag</button>
        <button class="btn ghost small" id="genBlueprintBtn">Generate Blueprint</button>
      </div>
      <table class="table space-top" id="tagsTable">
        <thead><tr><th>Placeholder</th><th>Type</th><th>Required</th><th>Options</th><th></th></tr></thead>
        <tbody></tbody>
      </table>

      <div class="section" style="margin-top:16px">
        <h3>Blueprint Preview</h3>
        <div id="blueprint" class="small muted">Generate a blueprint to preview the final digital trade template.</div>
      </div>

      <hr class="sep"/>
      <h3>Investor Invitations</h3>
      <div class="row">
        <input class="input" id="invEmail" placeholder="investor@example.com" style="width:260px"/>
        <button class="btn small" id="addInvBtn">Add</button>
        <div class="right small muted">Accepted: <span id="cAccepted">0</span> • Onboarding: <span id="cOnboarding">0</span> • Invested: <span id="cInvested">0</span></div>
      </div>
      <table class="table space-top" id="invTable">
        <thead><tr><th>Email</th><th>Status</th><th></th></tr></thead>
        <tbody></tbody>
      </table>

      <!-- Workflow row removed (duplicate at bottom) -->
    </div>
  </div>
</div>

      </section>
    </main>
  </div>
  <script>
(() => {
  const body = document.body;
  const page = body.getAttribute('data-page');
  // Activate nav
  document.querySelectorAll('.nav a').forEach(a => { if (a.dataset.nav === page) a.classList.add('active'); });
  // Animate progress
  const animate = () => {
    document.querySelectorAll('.progress > span[data-value]').forEach(el => {
      const v = parseInt(el.getAttribute('data-value'),10) || 0;
      el.style.width = '0%';
      setTimeout(() => el.style.width = v + '%', 120);
    });
  };
  animate();
  // "/" shortcut to focus search
  window.addEventListener('keydown', (e) => {
    if (e.key === '/' && !/input|textarea|select/i.test(document.activeElement.tagName)) {
      const i = document.querySelector('.search input'); if (i) { e.preventDefault(); i.focus(); }
    }
  });
})();
</script>
  <script>
(() => {
  const KEY = 'kyc_trades';
  // Utilities
  const $ = (sel) => document.querySelector(sel);
  const $all = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const fmt = (ts) => ts ? new Date(ts).toLocaleString() : '—';
  const stageOrder = ['created','legal','im','blueprint','invite','live'];
  const badge = (stage) => {
    const m = {created:'info', legal:'warn', im:'warn', blueprint:'', invite:'ok', live:'ok'};
    const cls = m[stage] || '';
    const label = stage.charAt(0).toUpperCase() + stage.slice(1);
    return `<span class="badge ${cls}">${label}</span>`;
  }
  const loadTrades = () => {
    let list = [];
    try { list = JSON.parse(localStorage.getItem(KEY) || '[]'); } catch(e){ list = []; }
    if (!list.length) { // seed one
      list = [{
        id:'DT-0001', name:'Seed Fund — Sustainable Credit A', closingDate:'2025-10-31',
        stage:'invite', closed:false, terms:'Subscription Terms for {{investor_name}} to invest {{amount}} {{currency}} by {{closing_date}}.',
        tags:[{name:'investor_name',type:'text',required:true},{name:'amount',type:'number',required:true},{name:'currency',type:'dropdown',required:true,options:'USD,EUR'}],
        investors:[{email:'investor1@example.com', status:'accepted'},{email:'investor2@example.com', status:'onboarding'}],
        createdAt: Date.now()-86400000, updatedAt: Date.now()
      }];
      localStorage.setItem(KEY, JSON.stringify(list));
    }
    return list;
  }
  const saveTrades = (list) => { localStorage.setItem(KEY, JSON.stringify(list)); window.dispatchEvent(new StorageEvent('storage', {key:KEY, newValue:JSON.stringify(list)})); }
  const nextId = (list) => {
    const max = list.reduce((m,t)=> Math.max(m, parseInt((t.id||'').split('-')[1]||'0',10)), 0);
    const n = (max + 1).toString().padStart(4,'0');
    return `DT-${n}`;
  }
  const counts = (t) => {
    const a = t.investors.filter(i=>i.status==='accepted').length;
    const o = t.investors.filter(i=>i.status==='onboarding').length;
    const v = t.investors.filter(i=>i.status==='invested').length;
    return {a,o,v};
  }
  // Elements
  const tableBody = $('#tradesTable tbody');
  const filters = $('#tradeFilters');
  const newBtn = $('#newTradeBtn');
  const openById = $('#openById');
  const openByIdBtn = $('#openByIdBtn');
  const noTrade = $('#noTrade');
  const panel = $('#tradePanel');
  const tId = $('#tId'); const tUpdated=$('#tUpdated'); const tName=$('#tName'); const tClose=$('#tClose'); const tTerms=$('#tTerms');
  const loadTermsBtn = $('#loadTermsBtn'); const termsFile=$('#termsFile');
  const tagName=$('#tagName'); const tagType=$('#tagType'); const tagReq=$('#tagReq'); const tagOpts=$('#tagOpts'); const addTagBtn=$('#addTagBtn');
  const invEmail=$('#invEmail'); const addInvBtn=$('#addInvBtn');
  const blueprint=$('#blueprint');
  const toLegalBtn=$('#toLegalBtn'); const toIMBtn=$('#toIMBtn'); const toBlueprintBtn=$('#toBlueprintBtn'); const toInviteBtn=$('#toInviteBtn'); const markLiveBtn=$('#markLiveBtn');
  const saveBtn=$('#saveBtn');
  // Init
  let trades = loadTrades();
  let editMode = false;
  let tradeBackup = null;
  const setEditMode = (on) => {
    editMode = on;
    [tName, tClose, tTerms].forEach(el => { el.disabled = !on; });
    $('#editBtn').classList.toggle('hidden', on);
    $('#deleteBtn').classList.toggle('hidden', !on);
    saveBtn.disabled = !on;
  };
  const init = () => {
    // Table
    const rows = trades.map(t => {
      const c = counts(t);
      return `<tr data-id="${t.id}">
        <td><input type="checkbox" class="tradeSelect" data-id="${t.id}"/></td>
        <td class="muted" style="white-space:nowrap">${t.id}</td>
        <td>${t.name}</td>
        <td style="white-space:nowrap">${badge(t.stage)} ${t.stage}</td>
        <td class="muted" style="white-space:nowrap">${c.a}</td>
        <td class="muted" style="white-space:nowrap">${c.o}</td>
        <td class="muted" style="white-space:nowrap">${c.v}</td>
        <td class="muted" style="white-space:nowrap">${fmt(t.updatedAt)}</td>
      </tr>`;
    }).join('');
    tableBody.innerHTML = rows || `<tr><td colspan="8" class="small muted">No trades found. Create a new trade document to get started.</td></tr>`;
    // Bulk select logic
    const selectAll = document.getElementById('selectAllTrades');
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    const updateBulkDeleteBtn = () => {
      const checked = Array.from(document.querySelectorAll('.tradeSelect:checked'));
      bulkDeleteBtn.style.display = checked.length ? '' : 'none';
    };
    if (selectAll) {
      selectAll.addEventListener('change', (e) => {
        const checked = selectAll.checked;
        document.querySelectorAll('.tradeSelect').forEach(cb => { cb.checked = checked; });
        updateBulkDeleteBtn();
      });
    }
    tableBody.addEventListener('change', (e) => {
      if (e.target.classList.contains('tradeSelect')) {
        updateBulkDeleteBtn();
        // Uncheck selectAll if any unchecked
        if (!e.target.checked && selectAll) selectAll.checked = false;
      }
    });
    if (bulkDeleteBtn) {
      bulkDeleteBtn.addEventListener('click', () => {
        const checked = Array.from(document.querySelectorAll('.tradeSelect:checked'));
        if (checked.length && confirm(`Delete ${checked.length} selected trade(s)?`)) {
          const ids = checked.map(cb => cb.dataset.id);
          trades = trades.filter(t => !ids.includes(t.id));
          saveTrades(trades);
          bulkDeleteBtn.style.display = 'none';
          init();
        }
      });
    }
    // Filters
    const filterBtns = filters.querySelectorAll('.pill');
    filterBtns.forEach(b => {
      b.addEventListener('click', () => {
        const f = b.dataset.f;
        filterBtns.forEach(btn => btn.classList.toggle('active', btn === b));
        tableBody.querySelectorAll('tr').forEach(row => {
          const id = row.dataset.id;
          const t = trades.find(t => t.id === id) || {};
          const show = f === 'all' || t.stage === f;
          row.style.display = show ? '' : 'none';
        });
      });
    });
    // Open by ID
    openByIdBtn.addEventListener('click', () => {
      const id = openById.value.trim();
      const trade = trades.find(t => t.id === id);
      if (trade) { openTrade(trade); } else { alert('Trade not found'); }
    });
    // ...existing code...
    // Table row click
    tableBody.addEventListener('click', e => {
      const tr = e.target.closest('tr');
      if (tr) {
        const id = tr.dataset.id;
        const trade = trades.find(t => t.id === id);
        if (trade) { openTrade(trade); }
      }
    });
    // Init empty state
    noTrade.classList.toggle('hidden', trades.length > 0);
    panel.classList.add('hidden');
  }
  const openTrade = (trade) => {
    if (!trade) return;
    const isNew = !trade.id;
    // Fill fields
    tId.innerText = trade.id || '—';
    tUpdated.innerText = fmt(trade.updatedAt);
    tName.value = trade.name || '';
    tClose.value = trade.closingDate || '';
    tTerms.value = trade.terms || '';
    // Stepper status coloring
    const stages = ['created','legal','im','blueprint','invite','live'];
    let currentIdx = stages.indexOf(trade.stage);
    $all('.step', panel).forEach((el, idx) => {
      el.classList.remove('done','next','notstarted');
      if (idx < currentIdx) {
        el.classList.add('done');
      } else if (idx === currentIdx) {
        el.classList.add('next');
      } else {
        el.classList.add('notstarted');
      }
    });
    // Disable editing by default
    setEditMode(false);
    tradeBackup = JSON.parse(JSON.stringify(trade));
    panel.classList.remove('hidden');
    noTrade.classList.add('hidden');
    // TODO: Fill tags, investors, etc. (existing logic)
  }
  // Init
  init();
  // Storage event
  window.addEventListener('storage', (e) => {
    if (e.key === KEY) {
      trades = loadTrades();
      init();
    }
  });
  // New trade document button
  $('#newTradeBtn').addEventListener('click', () => {
    const id = nextId(trades);
    const now = Date.now();
    const newTrade = {
      id, name:'', closingDate:'', stage:'created', closed:false,
      terms:'', tags:[], investors:[],
      createdAt: now, updatedAt: now
    };
    trades.push(newTrade);
    saveTrades(trades);
    openTrade(newTrade);
  });
  // Open trade by ID
  $('#openByIdBtn').addEventListener('click', () => {
    const id = $('#openById').value.trim();
    const trade = trades.find(t => t.id === id);
    if (trade) {
      openTrade(trade);
    } else {
      alert('Trade not found');
    }
  });
  // Filter pills
  $('#tradeFilters').addEventListener('click', e => {
    if (e.target.classList.contains('pill')) {
      const filter = e.target.dataset.f;
      $('#tradeFilters .pill.active').classList.remove('active');
      e.target.classList.add('active');
      tableBody.querySelectorAll('tr').forEach(row => {
        const id = row.dataset.id;
        const t = trades.find(t => t.id === id) || {};
        const show = filter === 'all' || t.stage === filter;
        row.style.display = show ? '' : 'none';
      });
    }
  });
  // Table row click
  tableBody.addEventListener('click', e => {
    const tr = e.target.closest('tr');
    if (tr) {
      const id = tr.dataset.id;
      const trade = trades.find(t => t.id === id);
      if (trade) { openTrade(trade); }
    }
  });
  // Close trade panel
  $('#tradePanel').addEventListener('click', e => {
    if (e.target.classList.contains('close')) {
      $('#tradePanel').classList.add('hidden');
    }
  });
  // Edit button
  $('#editBtn').addEventListener('click', () => {
    setEditMode(true);
  });
  // Delete button
  $('#deleteBtn').addEventListener('click', () => {
    const id = $('#tId').innerText.trim();
    const idx = trades.findIndex(t => t.id === id);
    if (idx !== -1) {
      if (confirm('Are you sure you want to delete this trade document?')) {
        trades.splice(idx, 1);
        saveTrades(trades);
        panel.classList.add('hidden');
        noTrade.classList.remove('hidden');
        init();
      }
    }
  });
  // Save trade document
  $('#saveBtn').addEventListener('click', () => {
    if (!editMode) return;
    const id = $('#tId').innerText.trim();
    const trade = trades.find(t => t.id === id);
    if (trade) {
      trade.name = $('#tName').value.trim();
      trade.closingDate = $('#tClose').value.trim();
      trade.terms = $('#tTerms').value.trim();
      trade.updatedAt = Date.now();
      saveTrades(trades);
      setEditMode(false);
      openTrade(trade);
    }
  });
  // Load terms file
  $('#loadTermsBtn').addEventListener('click', () => {
    const fileInput = $('#termsFile');
    const file = fileInput.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        $('#tTerms').value = e.target.result;
      };
      reader.readAsText(file);
    }
  });
  // Add data tag
  $('#addTagBtn').addEventListener('click', () => {
    const name = $('#tagName').value.trim();
    const type = $('#tagType').value;
    const required = $('#tagReq').value === 'true';
    const opts = $('#tagOpts').value.split(',').map(o => o.trim()).filter(o => o);
    if (name) {
      const tag = {name, type, required};
      if (opts.length) tag.options = opts;
      const trade = trades.find(t => t.id === $('#tId').innerText.trim());
      if (trade) {
        trade.tags.push(tag);
        saveTrades(trades);
        openTrade(trade);
      }
    }
  });
  // Generate blueprint
  $('#genBlueprintBtn').addEventListener('click', () => {
    const trade = trades.find(t => t.id === $('#tId').innerText.trim());
    if (trade) {
      const blueprint = `Blueprint for ${trade.name} (${trade.id})

T&Cs:
${trade.terms}

Data Tags:
${trade.tags.map(t => `- ${t.name} (${t.type})${t.required ? ' [Required]' : ''}`).join('\n')}

Investor Invitations:
${trade.investors.map(i => `- ${i.email} (${i.status})`).join('\n')}

Workflow Stage: ${trade.stage}
`;
      $('#blueprint').innerText = blueprint;
    }
  });
  // Add investor
  $('#addInvBtn').addEventListener('click', () => {
    const email = $('#invEmail').value.trim();
    if (email) {
      const trade = trades.find(t => t.id === $('#tId').innerText.trim());
      if (trade) {
        const exists = trade.investors.find(i => i.email === email);
        if (!exists) {
          trade.investors.push({email, status:'onboarding'});
          saveTrades(trades);
          openTrade(trade);
        } else {
          alert('Investor already added');
        }
      }
    }
  });
  // Workflow buttons
  $('#toLegalBtn').addEventListener('click', () => {
    const trade = trades.find(t => t.id === $('#tId').innerText.trim());
    if (trade) {
      trade.stage = 'legal';
      saveTrades(trades);
      openTrade(trade);
    }
  });
  $('#toIMBtn').addEventListener('click', () => {
    const trade = trades.find(t => t.id === $('#tId').innerText.trim());
    if (trade) {
      trade.stage = 'im';
      saveTrades(trades);
      openTrade(trade);
    }
  });
  $('#toBlueprintBtn').addEventListener('click', () => {
    const trade = trades.find(t => t.id === $('#tId').innerText.trim());
    if (trade) {
      trade.stage = 'blueprint';
      saveTrades(trades);
      openTrade(trade);
    }
  });
  $('#toInviteBtn').addEventListener('click', () => {
    const trade = trades.find(t => t.id === $('#tId').innerText.trim());
    if (trade) {
      trade.stage = 'invite';
      saveTrades(trades);
      openTrade(trade);
    }
  });
  $('#markLiveBtn').addEventListener('click', () => {
    const trade = trades.find(t => t.id === $('#tId').innerText.trim());
    if (trade) {
      trade.stage = 'live';
      trade.closed = true;
      saveTrades(trades);
      openTrade(trade);
    }
  });
})();
</script>
</body>
</html>
