<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Digital Trading Â· KYC Orchestrator</title>
  <style>
:root{
  --sidebar-width: 170px;
  --sidebar-font-size: 11px;
  --sidebar-title-size: 13px;
  --sidebar-tag-size: 10px;
  --sidebar-icon-size: 18px;
  --page:#ffffff;              /* white background */
  --text:#0f172a;              /* deep slate for text */
  --muted:#475569;             /* slate-600 for muted text */
  --line:#e5e7eb;              /* gray-200 borders */
  --card:#ffffff;              /* white surfaces */
  --sidebar: rgba(33,207,178,0.20);  /* 20% teal */
  --btn: rgba(33,207,178,0.60);      /* 60% teal */
  --btn-border: rgba(33,207,178,0.60);
  --btn-text:#0b1220;          /* dark text on light teal */
  --link:#0ea5e9;              /* cyan-500 */
  --task:#a399ff;              /* action task chips */
  --success:#059669;           /* green-600 */
  --warn:#d97706;              /* amber-600 */
  --danger:#dc2626;            /* red-600 */
  --info:#2563eb;              /* blue-600 */
  --progress:#21cfb2;          /* teal solid for progress fill */
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial;
  background: var(--page);
  color:var(--text);
  line-height:1.45;
}
a{color:var(--link); text-decoration:none}
a:hover{text-decoration:underline}

/* Layout */

.app{display:grid; grid-template-columns: var(--sidebar-width) 1fr; min-height:100vh}
.sidebar{background: var(--sidebar); border-right:1px solid var(--line); padding:10px 4px; position:sticky; top:0; height:100vh; overflow:auto; font-size:var(--sidebar-font-size); min-width:var(--sidebar-width); max-width:var(--sidebar-width);}
.brand{display:flex; align-items:center; gap:6px; margin:6px 2px 10px 2px;}
.brand .logo{width:24px; height:24px; border-radius:8px; background: radial-gradient(circle at 25% 20%, rgba(33,207,178,0.9) 0%, rgba(33,207,178,0.6) 45%, rgba(33,207,178,0.4) 80%); box-shadow:0 8px 24px rgba(33,207,178,.35);}
.brand h1{font-size:var(--sidebar-title-size); letter-spacing:.3px; margin:0}
.nav{margin-top:4px}
.nav a{display:flex; align-items:center; gap:8px; padding:6px 6px; border-radius:8px; color:#0b1220; border:1px solid transparent; font-size:var(--sidebar-font-size);}
.nav a:hover{background:rgba(33,207,178,0.12); border-color:rgba(33,207,178,0.18); text-decoration:none}
.nav a.active{background: rgba(33,207,178,0.18); border-color:rgba(33,207,178,0.28); color:#0b1220; box-shadow: inset 0 0 0 1px rgba(33,207,178,0.20);}
.nav .icon{width:var(--sidebar-icon-size); height:var(--sidebar-icon-size); display:inline-block}
.nav .tag{margin-left:auto; font-size:var(--sidebar-tag-size); padding:2px 6px; border-radius:999px; background:rgba(33,207,178,0.18); color:#0b1220; border:1px solid rgba(33,207,178,0.28)}
.footer-note{margin-top:10px; font-size:10px; color:var(--muted); opacity:.85; padding:0 3px}

/* Top bar */
.header{
  display:flex; align-items:center; justify-content:space-between;
  padding:16px 22px; position:sticky; top:0; z-index:5;
  background:rgba(255,255,255,0.9);
  backdrop-filter: blur(6px);
  border-bottom: 1px solid var(--line);
}
.search{
  display:flex; align-items:center; gap:8px; border:1px solid var(--line);
  background: var(--card);
  padding:10px 12px; border-radius:12px; width:52%;
}
.search input{
  flex:1; background:transparent; border:none; outline:none; color:var(--text);
}
.actions{display:flex; align-items:center; gap:10px}
.btn{
  background: var(--btn);
  border:1px solid var(--btn-border);
  color:var(--btn-text); padding:10px 12px; border-radius:10px; cursor:pointer;
  transition: filter .15s ease, transform .02s ease;
}
.btn:hover{filter:brightness(1.05)}
.btn:active{transform:translateY(1px)}
.btn.primary{background: var(--btn); border-color: var(--btn-border)}
.btn.ghost{background:transparent; color: var(--btn-text); border-color: var(--btn-border)}
.btn.small{padding:6px 10px; font-size:12px}
.kbd{font: 12px/1.6 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; padding:2px 6px; border-radius:6px; border:1px solid var(--line); color:var(--muted)}

/* Content */
.content{padding:14px 22px 40px}
.page-title{display:flex; align-items:baseline; justify-content:space-between; gap:12px; margin:12px 0 8px 0}
.page-title h2{margin:0; font-size:22px}
.page-title .sub{color:var(--muted)}

/* Cards & sections */
.cards{display:grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap:14px; margin:14px 0 6px}
.card{
  background: var(--card);
  border:1px solid var(--line); border-radius:14px; padding:12px 14px; min-height:72px;
  box-shadow: 0 8px 28px rgba(2,6,23,.06);
}
.card .label{color:var(--muted); font-size:12px}
.card .value{font-size:22px; margin-top:2px}
.card .trend{font-size:12px; color:#047857}
.card .danger{color:var(--danger)}

.grid-2{display:grid; grid-template-columns: 2fr 1fr; gap:16px; margin-top:16px}
.grid-3{display:grid; grid-template-columns: repeat(3, 1fr); gap:16px; margin-top:16px}
.section{background: var(--card); border:1px solid var(--line); border-radius:14px; padding:16px}
.section h3{margin:0 0 10px 0; font-size:16px}

/* Table */
.table{width:100%; border-collapse:separate; border-spacing:0 8px; font-size:14px}
.table th{color:var(--muted); text-align:left; font-weight:600; padding:8px 10px; border-bottom:1px solid var(--line)}
.table td{padding:10px; background:#ffffff; border:1px solid var(--line)}
.table tr td:first-child{border-top-left-radius:10px; border-bottom-left-radius:10px}
.table tr td:last-child{border-top-right-radius:10px; border-bottom-right-radius:10px}

/* Badges & pills */
.badge{font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--line); background:#f8fafc; color:#0b1220}
.badge.ok{border-color:#065f46; background:#ecfdf5; color:#065f46}
.badge.warn{border-color:#92400e; background:#fffbeb; color:#92400e}
.badge.danger{border-color:#7f1d1d; background:#fef2f2; color:#7f1d1d}
.badge.info{border-color:#1e3a8a; background:#eff6ff; color:#1e3a8a}
/* Action task badge in requested color */
.badge.task{border-color:#6f63ff; background:#a399ff; color:#ffffff}

.pills{display:flex; gap:8px; flex-wrap:wrap}
.pill{padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:#f8fafc; cursor:pointer; font-size:12px; color:#0b1220}
.pill.active{background:rgba(33,207,178,0.18); border-color:rgba(33,207,178,0.28)}

/* Progress */
.progress{width:100%; height:10px; border-radius:999px; background:#f1f5f9; border:1px solid var(--line); overflow:hidden}
.progress > span{display:block; height:100%; background:linear-gradient(90deg, var(--progress), rgba(33,207,178,0.85)); width:0%}

/* Stepper */
.stepper{display:flex; gap:10px; flex-wrap:wrap}
.step{display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:10px; border:1px dashed #94a3b8; background:#f8fafc; color:#0b1220}
.step.current{border-style:solid; background:rgba(33,207,178,0.10)}
.step .dot{width:10px; height:10px; border-radius:50%; background:#94a3b8; border:2px solid #cbd5e1}
.step.done .dot{background:#059669; border-color:#059669}
.step.current .dot{background:var(--progress)}

/* Forms */
.form-grid{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px}
.label{font-size:12px; color:var(--muted); margin-bottom:6px}
.input, select, textarea{
  width:100%; background:#ffffff; color:var(--text); border:1px solid var(--line); border-radius:10px; padding:10px 12px
}
.row{display:flex; gap:10px; align-items:center}
hr.sep{border:0; border-top:1px solid var(--line); margin:14px 0}

/* Utilities */
.right{margin-left:auto}
.muted{color:var(--muted)}
.small{font-size:12px}
.space-top{margin-top:10px}
.center{display:flex; align-items:center; justify-content:center}
.hidden{display:none!important}

/* Responsive */
@media (max-width:1100px){
  .app{grid-template-columns: 80px 1fr}
  .brand h1, .footer-note, .nav a .text, .nav a .tag{display:none}
  .nav a{justify-content:center}
  .search{width:70%}
}
@media (max-width:800px){
  .cards{grid-template-columns: repeat(2, 1fr)}
  .grid-2{grid-template-columns: 1fr}
  .grid-3{grid-template-columns: 1fr}
  .form-grid{grid-template-columns: 1fr}
}
</style>
</head>
<body data-page="digital">
  <a href="#main" class="kbd" style="position:absolute; left:-9999px; top:-9999px">Skip to content</a>
  <div class="app">
    
    <aside class="sidebar" aria-label="Sidebar Navigation">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>KYC Orchestrator</h1>
      </div>
      <nav class="nav">
        <a href="index.html" data-nav="dashboard" aria-label="Dashboard">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 12l9-9 9 9" stroke="#0b1220" stroke-width="1.5"/><path d="M5 10v10h5v-6h4v6h5V10" stroke="#0b1220" stroke-width="1.5"/></svg>
          <span class="text">Dashboard</span>
        </a>
        <a href="fund-launch.html" data-nav="fund-launch" aria-label="Fund Launch">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 19h16M7 19V7a3 3 0 0 1 3-3h4a3 3 0 0 1 3 3v12" stroke="#0b1220" stroke-width="1.5"/><path d="M9 9h6m-6 4h6" stroke="#0b1220" stroke-width="1.5"/></svg>
          <span class="text">Fund Launch</span>
          <span class="tag">Product</span>
        </a>
        <a href="distributor-onboarding.html" data-nav="distributor" aria-label="Distributor Onboarding">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M7 8h10a4 4 0 0 1 4 4v6H3v-6a4 4 0 0 1 4-4z" stroke="#0b1220" stroke-width="1.5"/><path d="M7 8V6a5 5 0 0 1 10 0v2" stroke="#0b1220" stroke-width="1.5"/></svg>
          <span class="text">Distributor Onboarding</span>
          <span class="tag">KYD</span>
        </a>
        <a href="investor-onboarding.html" data-nav="investor" aria-label="Investor Onboarding">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5z" stroke="#0b1220" stroke-width="1.5"/><path d="M3 21a9 9 0 0 1 18 0" stroke="#0b1220" stroke-width="1.5"/></svg>
          <span class="text">Investor Onboarding</span>
          <span class="tag">KYC/KYB</span>
        </a>
        <a href="asset-dd.html" data-nav="asset" aria-label="Asset & Vehicle Due Diligence">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 7h18M3 12h18M3 17h18" stroke="#0b1220" stroke-width="1.5"/><path d="M8 7v12m8-12v12" stroke="#0b1220" stroke-width="1.5"/></svg>
          <span class="text">Asset & Vehicle DD</span>
          <span class="tag">KYI</span>
        </a>
        <a href="monitoring.html" data-nav="monitoring" aria-label="Monitoring & Screening">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 13l4 4 12-12" stroke="#0b1220" stroke-width="1.5"/></svg>
          <span class="text">Monitoring & Screening</span>
          <span class="tag">KYT</span>
        </a>
        <a href="digital-trading.html" data-nav="digital" aria-label="Digital Trading">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M4 6h16v12H4z" stroke="#0b1220" stroke-width="1.5"/><path d="M8 10h8M8 14h5" stroke="#0b1220" stroke-width="1.5"/>
          </svg>
          <span class="text">Digital Trading</span>
          <span class="tag">Trades</span>
        </a>
      </nav>
      <div class="footer-note">Prototype â¢ Static HTML â¢ Local storage</div>
    </aside>
    
    <main class="main">
      <header class="header" role="banner">
        <div class="search" role="search" aria-label="Search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="11" cy="11" r="7" stroke="#64748b" stroke-width="1.5"/><path d="M20 20l-3-3" stroke="#64748b" stroke-width="1.5"/></svg>
          <input placeholder="Search parties, products, accounts, casesâ¦ (press / to focus)" aria-label="Global search"/>
          <span class="kbd">/</span>
        </div>
        <div class="actions">
          <button class="btn ghost" aria-label="New case">New Case</button>
          <button class="btn primary" aria-label="Add party">+ Add Party</button>
        </div>
      </header>
      <section class="content" id="main">
        <div class="page-title">
          <h2>Digital Trading</h2>
          <div class="sub">Create/upload T&Cs â¢ Data tags â¢ Workflow â¢ Investor invitations â¢ Blueprint</div>
        </div>
        
<div class="grid-2">
  <div class="section">
    <div class="row">
      <h3>My Fund Portfolio</h3>
      <div class="right">
        <button class="btn small" id="newTradeBtn">+ New Trade Document</button>
      </div>
    </div>
    <div class="row space-top">
      <div class="pills" id="tradeFilters">
        <span class="pill active" data-f="all">All</span>
        <span class="pill" data-f="open">Open</span>
        <span class="pill" data-f="closed">Closed</span>
      </div>
      <div class="right row">
        <input class="input" id="openById" placeholder="Enter Fund ID e.g., DT-0001" style="width:240px"/>
        <button class="btn small" id="openByIdBtn">Open</button>
      </div>
    </div>
    <table class="table space-top" id="tradesTable">
      <thead><tr><th>ID</th><th>Name</th><th>Stage</th><th>Accepted</th><th>Onboarding</th><th>Invested</th><th>Updated</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="small muted">Click a row to open the trade document builder. âOpenâ = not archived; âClosedâ = marked Live & Closed.</div>
  </div>

  <div class="section">
    <h3>Trade Document Builder</h3>
    <div id="noTrade" class="small muted">Select a trade from the left or create a new one.</div>
    <div id="tradePanel" class="hidden">
      <div class="row"><span class="badge info">Trade ID</span> <strong id="tId">â</strong><div class="right small muted">Updated <span id="tUpdated">â</span></div></div>
      <div class="space-top stepper">
        <div class="step" data-s="created"><div class="dot"></div> Created</div>
        <div class="step" data-s="legal"><div class="dot"></div> Legal Review</div>
        <div class="step" data-s="im"><div class="dot"></div> IM Approval</div>
        <div class="step" data-s="blueprint"><div class="dot"></div> Blueprint</div>
        <div class="step" data-s="invite"><div class="dot"></div> Investor Invitations</div>
        <div class="step" data-s="live"><div class="dot"></div> Live</div>
      </div>

      <hr class="sep"/>
      <h3>Digital Trade Setup</h3>
      <div class="form-grid">
        <div><div class="label">Fund Name</div><input class="input" id="tName" placeholder="e.g., Sustainable Credit A â Oct 2025"/></div>
        <div><div class="label">Closing Date</div><input class="input" id="tClose" placeholder="YYYY-MM-DD"/></div>
        <div style="grid-column: 1 / -1"><div class="label">T&Cs (paste text or load file)</div>
          <textarea id="tTerms" rows="6" placeholder="Enter legal terms and conditions... Use {{placeholders}} to indicate data tags."></textarea>
          <div class="row space-top">
            <input type="file" id="termsFile" class="input" style="padding:8px"/>
            <button class="btn small" id="loadTermsBtn">Load File</button>
            <div class="small muted">Plain text files recommended in this prototype.</div>
          </div>
        </div>
      </div>

      <hr class="sep"/>
      <h3>Data Tags</h3>
      <div class="form-grid">
        <div><div class="label">Tag Name</div><input class="input" id="tagName" placeholder="e.g., amount"/></div>
        <div><div class="label">Type</div>
          <select id="tagType">
            <option value="text">Text</option>
            <option value="number">Number</option>
            <option value="date">Date</option>
            <option value="dropdown">Dropdown</option>
          </select>
        </div>
        <div><div class="label">Required?</div><select id="tagReq"><option value="true">Yes</option><option value="false">No</option></select></div>
        <div id="optsWrap"><div class="label">Options (comma separated)</div><input class="input" id="tagOpts" placeholder="e.g., USD,EUR,GBP"/></div>
      </div>
      <div class="row space-top">
        <button class="btn small" id="addTagBtn">Add Tag</button>
        <button class="btn ghost small" id="genBlueprintBtn">Generate Blueprint</button>
      </div>
      <table class="table space-top" id="tagsTable">
        <thead><tr><th>Placeholder</th><th>Type</th><th>Required</th><th>Options</th><th></th></tr></thead>
        <tbody></tbody>
      </table>

      <div class="section" style="margin-top:16px">
        <h3>Blueprint Preview</h3>
        <div id="blueprint" class="small muted">Generate a blueprint to preview the final digital trade template.</div>
      </div>

      <hr class="sep"/>
      <h3>Investor Invitations</h3>
      <div class="row">
        <input class="input" id="invEmail" placeholder="investor@example.com" style="width:260px"/>
        <button class="btn small" id="addInvBtn">Add</button>
        <div class="right small muted">Accepted: <span id="cAccepted">0</span> â¢ Onboarding: <span id="cOnboarding">0</span> â¢ Invested: <span id="cInvested">0</span></div>
      </div>
      <table class="table space-top" id="invTable">
        <thead><tr><th>Email</th><th>Status</th><th></th></tr></thead>
        <tbody></tbody>
      </table>

      <hr class="sep"/>
      <h3>Workflow</h3>
      <div class="row">
        <button class="btn small" id="toLegalBtn">Send to Legal</button>
        <button class="btn small" id="toIMBtn">IM Approve</button>
        <button class="btn small" id="toBlueprintBtn">To Blueprint</button>
        <button class="btn small" id="toInviteBtn">Invite Investors</button>
        <button class="btn small" id="markLiveBtn">Mark Live & Close</button>
        <div class="right">
          <button class="btn primary small" id="saveBtn">Save Trade Document</button>
        </div>
      </div>
    </div>
  </div>
</div>

      </section>
    </main>
  </div>
  <script>
(() => {
  const body = document.body;
  const page = body.getAttribute('data-page');
  // Activate nav
  document.querySelectorAll('.nav a').forEach(a => { if (a.dataset.nav === page) a.classList.add('active'); });
  // Animate progress
  const animate = () => {
    document.querySelectorAll('.progress > span[data-value]').forEach(el => {
      const v = parseInt(el.getAttribute('data-value'),10) || 0;
      el.style.width = '0%';
      setTimeout(() => el.style.width = v + '%', 120);
    });
  };
  animate();
  // "/" shortcut to focus search
  window.addEventListener('keydown', (e) => {
    if (e.key === '/' && !/input|textarea|select/i.test(document.activeElement.tagName)) {
      const i = document.querySelector('.search input'); if (i) { e.preventDefault(); i.focus(); }
    }
  });
})();
</script>
  <script>
(() => {
  const KEY = 'kyc_trades';
  // Utilities
  const $ = (sel) => document.querySelector(sel);
  const $all = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const fmt = (ts) => ts ? new Date(ts).toLocaleString() : 'â';
  const stageOrder = ['created','legal','im','blueprint','invite','live'];
  const badge = (stage) => {
    const m = {created:'info', legal:'warn', im:'warn', blueprint:'', invite:'ok', live:'ok'};
    const cls = m[stage] || '';
    const label = stage.charAt(0).toUpperCase() + stage.slice(1);
    return `<span class="badge ${cls}">${label}</span>`;
  }
  const loadTrades = () => {
    let list = [];
    try { list = JSON.parse(localStorage.getItem(KEY) || '[]'); } catch(e){ list = []; }
    if (!list.length) { // seed one
      list = [{
        id:'DT-0001', name:'Seed Fund â Sustainable Credit A', closingDate:'2025-10-31',
        stage:'invite', closed:false, terms:'Subscription Terms for {{investor_name}} to invest {{amount}} {{currency}} by {{closing_date}}.',
        tags:[{name:'investor_name',type:'text',required:true},{name:'amount',type:'number',required:true},{name:'currency',type:'dropdown',required:true,options:'USD,EUR'}],
        investors:[{email:'investor1@example.com', status:'accepted'},{email:'investor2@example.com', status:'onboarding'}],
        createdAt: Date.now()-86400000, updatedAt: Date.now()
      }];
      localStorage.setItem(KEY, JSON.stringify(list));
    }
    return list;
  }
  const saveTrades = (list) => { localStorage.setItem(KEY, JSON.stringify(list)); window.dispatchEvent(new StorageEvent('storage', {key:KEY, newValue:JSON.stringify(list)})); }
  const nextId = (list) => {
    const max = list.reduce((m,t)=> Math.max(m, parseInt((t.id||'').split('-')[1]||'0',10)), 0);
    const n = (max + 1).toString().padStart(4,'0');
    return `DT-${n}`;
  }
  const counts = (t) => {
    const a = t.investors.filter(i=>i.status==='accepted').length;
    const o = t.investors.filter(i=>i.status==='onboarding').length;
    const v = t.investors.filter(i=>i.status==='invested').length;
    return {a,o,v};
  }
  // Elements
  const tableBody = $('#tradesTable tbody');
  const filters = $('#tradeFilters');
  const newBtn = $('#newTradeBtn');
  const openById = $('#openById');
  const openByIdBtn = $('#openByIdBtn');
  const noTrade = $('#noTrade');
  const panel = $('#tradePanel');
  const tId = $('#tId'); const tUpdated=$('#tUpdated'); const tName=$('#tName'); const tClose=$('#tClose'); const tTerms=$('#tTerms');
  const loadTermsBtn = $('#loadTermsBtn'); const termsFile=$('#termsFile');
  const tagName=$('#tagName'); const tagType=$('#tagType'); const tagReq=$('#tagReq'); const tagOpts=$('#tagOpts'); const addTagBtn=$('#addTagBtn');
  const tagsTable = $('#tagsTable tbody'); const genBlueprintBtn=$('#genBlueprintBtn'); const blueprintDiv=$('#blueprint');
  const invEmail=$('#invEmail'); const addInvBtn=$('#addInvBtn'); const invTable=$('#invTable tbody');
  const cAccepted=$('#cAccepted'); const cOnboarding=$('#cOnboarding'); const cInvested=$('#cInvested');
  const toLegalBtn=$('#toLegalBtn'); const toIMBtn=$('#toIMBtn'); const toBlueprintBtn=$('#toBlueprintBtn'); const toInviteBtn=$('#toInviteBtn'); const markLiveBtn=$('#markLiveBtn'); const saveBtn=$('#saveBtn');
  // State
  let trades = loadTrades();
  let currentId = null;

  // Render trades list
  const renderList = (flt='all') => {
    const list = trades.filter(t => flt==='all' ? true : flt==='open' ? !t.closed : t.closed);
    tableBody.innerHTML = list.map(t => {
      const c = counts(t);
      return `<tr data-id="${t.id}" style="cursor:pointer">
        <td>${t.id}</td><td>${t.name || 'â'}</td><td>${badge(t.stage)}</td>
        <td>${c.a}</td><td>${c.o}</td><td>${c.v}</td><td>${fmt(t.updatedAt)}</td></tr>`;
    }).join('');
    tableBody.querySelectorAll('tr').forEach(tr => tr.addEventListener('click', () => openTrade(tr.getAttribute('data-id'))));
  }
  // Filters
  filters.addEventListener('click', (e) => {
    const p = e.target.closest('.pill'); if (!p) return;
    $all('.pill', filters).forEach(x => x.classList.remove('active')); p.classList.add('active');
    renderList(p.dataset.f);
  });
  // Open by ID
  openByIdBtn.addEventListener('click', () => { const id = openById.value.trim(); if (id) openTrade(id); });
  openById.addEventListener('keydown', (e) => { if (e.key==='Enter') openByIdBtn.click(); });

  // Stepper highlighting
  const stageOrderIndex = (s) => stageOrder.indexOf(s);
  const markStepper = (stage) => {
    $all('.step[data-s]').forEach(el => {
      const s = el.getAttribute('data-s');
      el.classList.remove('done','current');
      const idx = stageOrderIndex(stage), my = stageOrderIndex(s);
      if (my < idx) el.classList.add('done');
      if (my === idx) el.classList.add('current');
    });
  }

  // Populate panel for a trade
  const openTrade = (id) => {
    const t = trades.find(x => x.id === id);
    if (!t) { alert('Trade not found: ' + id); return; }
    currentId = id;
    noTrade.classList.add('hidden'); panel.classList.remove('hidden');
    tId.textContent = t.id; tUpdated.textContent = fmt(t.updatedAt);
    tName.value = t.name || ''; tClose.value = t.closingDate || ''; tTerms.value = t.terms || '';
    // tags
    tagsTable.innerHTML = (t.tags||[]).map((g, idx) => `<tr>
      <td>{{${g.name}}}</td><td>${g.type}</td><td>${g.required ? 'Yes' : 'No'}</td><td>${g.options || ''}</td>
      <td><button class="btn small" data-del="${idx}">Delete</button></td></tr>`).join('');
    tagsTable.querySelectorAll('button[data-del]').forEach(btn => btn.addEventListener('click', () => {
      const i = parseInt(btn.getAttribute('data-del'),10);
      trades.find(x => x.id===currentId).tags.splice(i,1); save(); openTrade(currentId);
    }));
    // investors
    renderInvestors(t);
    // blueprint
    blueprintDiv.textContent = (t.blueprint || '').trim() ? t.blueprint : 'Generate a blueprint to preview the final digital trade template.';
    markStepper(t.stage || 'created');
    // set buttons enabled/disabled by stage (simplified)
    toLegalBtn.disabled = (t.stage !== 'created');
    toIMBtn.disabled = (t.stage !== 'legal');
    toBlueprintBtn.disabled = (t.stage !== 'im');
    toInviteBtn.disabled = (t.stage !== 'blueprint');
    markLiveBtn.disabled = (t.stage !== 'invite');
  }

  const renderInvestors = (t) => {
    invTable.innerHTML = (t.investors||[]).map((i, idx) => `
      <tr>
        <td>${i.email}</td>
        <td>
          <select data-idx="${idx}">
            <option value="invited"${i.status==='invited'?' selected':''}>Invited</option>
            <option value="accepted"${i.status==='accepted'?' selected':''}>Accepted</option>
            <option value="onboarding"${i.status==='onboarding'?' selected':''}>Onboarding</option>
            <option value="invested"${i.status==='invested'?' selected':''}>Invested</option>
          </select>
        </td>
        <td><button class="btn small" data-rm="${idx}">Remove</button></td>
      </tr>`).join('');
    invTable.querySelectorAll('select[data-idx]').forEach(sel => sel.addEventListener('change', () => {
      const i = parseInt(sel.getAttribute('data-idx'),10);
      const tRef = trades.find(x => x.id===currentId);
      tRef.investors[i].status = sel.value; save();
      const c = counts(tRef); cAccepted.textContent=c.a; cOnboarding.textContent=c.o; cInvested.textContent=c.v;
    }));
    invTable.querySelectorAll('button[data-rm]').forEach(btn => btn.addEventListener('click', () => {
      const i = parseInt(btn.getAttribute('data-rm'),10);
      const tRef = trades.find(x => x.id===currentId);
      tRef.investors.splice(i,1); save(); openTrade(currentId);
    }));
    const c = counts(t); cAccepted.textContent=c.a; cOnboarding.textContent=c.o; cInvested.textContent=c.v;
  }

  // File loader for terms
  $('#loadTermsBtn').addEventListener('click', () => {
    const file = $('#termsFile').files && $('#termsFile').files[0];
    if (!file) { alert('Choose a file first.'); return; }
    const reader = new FileReader();
    reader.onload = (e) => { $('#tTerms').value = e.target.result; };
    reader.readAsText(file);
  });

  // Add tag
  const cleanName = (s) => (s||'').trim().toLowerCase().replace(/[^a-z0-9_]+/g,'_').replace(/^_+|_+$/g,'');
  $('#addTagBtn').addEventListener('click', () => {
    if (!currentId) { alert('Open or create a trade first.'); return; }
    const name = cleanName($('#tagName').value); if (!name) return alert('Enter a tag name');
    const type = $('#tagType').value;
    const required = ($('#tagReq').value === 'true');
    const options = (type==='dropdown') ? ($('#tagOpts').value||'') : '';
    const tRef = trades.find(x => x.id===currentId);
    tRef.tags = tRef.tags || [];
    if (tRef.tags.find(g => g.name===name)) return alert('Tag already exists.');
    tRef.tags.push({name, type, required, options});
    save(); openTrade(currentId);
    $('#tagName').value=''; $('#tagOpts').value='';
  });
  // Show/hide options field
  const optsWrap = document.getElementById('optsWrap');
  const showOpts = () => optsWrap.style.display = ($('#tagType').value==='dropdown') ? 'block' : 'none';
  showOpts(); $('#tagType').addEventListener('change', showOpts);

  // Generate blueprint
  $('#genBlueprintBtn').addEventListener('click', () => {
    if (!currentId) return;
    const tRef = trades.find(x => x.id===currentId);
    const header = `--- Digital Trade Template ---\nTrade: ${tRef.name||''} (${tRef.id})\nClosing: ${tRef.closingDate||''}\n`;
    const tagsJson = JSON.stringify(tRef.tags||[], null, 2);
    const body = (tRef.terms||'').trim() || '(no T&Cs provided)';
    tRef.blueprint = header + '\nTags:\n' + tagsJson + '\n\nT&Cs:\n' + body + '\n';
    save(); openTrade(currentId);
  });

  // Add investor
  $('#addInvBtn').addEventListener('click', () => {
    if (!currentId) { alert('Open or create a trade first.'); return; }
    const email = ($('#invEmail').value||'').trim(); if (!email) return;
    const tRef = trades.find(x => x.id===currentId);
    tRef.investors = tRef.investors || [];
    tRef.investors.push({email, status:'invited'});
    $('#invEmail').value=''; save(); openTrade(currentId);
  });

  // Workflow transitions
  $('#toLegalBtn').addEventListener('click', () => setStage('legal'));
  $('#toIMBtn').addEventListener('click', () => setStage('im'));
  $('#toBlueprintBtn').addEventListener('click', () => setStage('blueprint'));
  $('#toInviteBtn').addEventListener('click', () => setStage('invite'));
  $('#markLiveBtn').addEventListener('click', () => { setStage('live'); archive(true); });

  const setStage = (stage) => {
    if (!currentId) return;
    const tRef = trades.find(x => x.id===currentId);
    tRef.stage = stage; save(); openTrade(currentId);
  }
  const archive = (val) => {
    const tRef = trades.find(x => x.id===currentId); tRef.closed = !!val; save(); renderList(currentFilter()); 
  }

  // Save trade
  const save = () => {
    const tRef = trades.find(x => x.id===currentId);
    if (tRef) {
      tRef.name = $('#tName').value.trim();
      tRef.closingDate = $('#tClose').value.trim();
      tRef.terms = $('#tTerms').value;
      tRef.updatedAt = Date.now();
    }
    saveTrades(trades);
  }
  $('#saveBtn').addEventListener('click', save);

  // New trade
  $('#newTradeBtn').addEventListener('click', () => {
    const id = nextId(trades);
    const t = {id, name:'Untitled Trade', closingDate:'', stage:'created', closed:false, terms:'', tags:[], investors:[], createdAt:Date.now(), updatedAt:Date.now()};
    trades.push(t); saveTrades(trades); renderList(currentFilter()); openTrade(id);
  });

  // Helper to get current filter
  const currentFilter = () => (document.querySelector('.pill.active')?.dataset.f) || 'all';

  // Initial render
  renderList('all');
  // If a hash id is present, open it e.g. digital-trading.html#DT-0001
  if (location.hash && location.hash.startsWith('#DT-')) { openTrade(location.hash.slice(1)); }
})();
</script>
</body>
</html>
