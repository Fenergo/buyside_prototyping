<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Distributor Onboarding Â· KYC Orchestrator</title>
  <style>
:root{
  --sidebar-bg: #f7fafd;
  --sidebar-icon: #4976a4;
  --sidebar-text: #4976a4;
  --sidebar-width: 80px;
  --sidebar-font-size: 12px;
  --sidebar-title-size: 13px;
  --sidebar-tag-size: 10px;
  --sidebar-icon-size: 28px;
  --sidebar-active: #e3eefa;
  --sidebar-width: 170px;
  --sidebar-font-size: 11px;
  --sidebar-title-size: 13px;
  --sidebar-tag-size: 10px;
  --sidebar-icon-size: 18px;
  --page:#ffffff;              /* white background */
  --text:#0f172a;              /* deep slate for text */
  --muted:#475569;             /* slate-600 for muted text */
  --line:#e5e7eb;              /* gray-200 borders */
  --card:#ffffff;              /* white surfaces */
  --sidebar: rgba(33,207,178,0.20);  /* 20% teal */
  --btn: rgba(33,207,178,0.60);      /* 60% teal */
  --btn-border: rgba(33,207,178,0.60);
  --btn-text:#0b1220;          /* dark text on light teal */
  --link:#0ea5e9;              /* cyan-500 */
  --task:#a399ff;              /* action task chips */
  --success:#059669;           /* green-600 */
  --warn:#d97706;              /* amber-600 */
  --danger:#dc2626;            /* red-600 */
  --info:#2563eb;              /* blue-600 */
  --progress:#21cfb2;          /* teal solid for progress fill */
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial;
  background: var(--page);
  color:var(--text);
  line-height:1.45;
}
a{color:var(--link); text-decoration:none}
a:hover{text-decoration:underline}

/* Layout */

.app{display:grid; grid-template-columns: var(--sidebar-width) 1fr; min-height:100vh}
.sidebar {
  background: var(--sidebar-bg);
  border-right: 1px solid var(--line);
  width: var(--sidebar-width);
  min-width: var(--sidebar-width);
  max-width: var(--sidebar-width);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  height: 100vh;
  padding: 0;
}
.sidebar .brand {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 24px 0 0 0;
}
.sidebar .logo {
  width: 36px;
  height: 36px;
  border-radius: 12px;
  background: radial-gradient(circle at 25% 20%, #4976a4 0%, #e3eefa 100%);
  margin-bottom: 8px;
}
.sidebar .brand h1 {
  font-size: 14px;
  color: var(--sidebar-text);
  margin: 0;
  font-weight: 600;
  letter-spacing: 0.2px;
}
.sidebar .nav {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 28px;
  margin-top: 24px;
}
.sidebar .nav a {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  color: var(--sidebar-text);
  text-decoration: none;
  font-size: var(--sidebar-font-size);
  padding: 0;
  border-radius: 8px;
  width: 100%;
  transition: background 0.15s;
}
.sidebar .nav a.active, .sidebar .nav a:hover {
  background: var(--sidebar-active);
}
.sidebar .nav .icon {
  width: var(--sidebar-icon-size);
  height: var(--sidebar-icon-size);
  color: var(--sidebar-icon);
  display: block;
}
.sidebar .nav .text {
  font-size: var(--sidebar-font-size);
  color: var(--sidebar-text);
  text-align: center;
  margin-top: 2px;
}
.sidebar .nav .tag {
  display: none;
}
.sidebar .footer-note {
  margin-top: 10px;
  font-size: 10px;
  color: var(--muted);
  opacity: .85;
  padding: 0 3px;
  margin-bottom: 18px;
}

/* Top bar */
.header{
  display:flex; align-items:center; justify-content:space-between;
  padding:16px 22px; position:sticky; top:0; z-index:5;
  background:rgba(255,255,255,0.9);
  backdrop-filter: blur(6px);
  border-bottom: 1px solid var(--line);
}
.search{
  display:flex; align-items:center; gap:8px; border:1px solid var(--line);
  background: var(--card);
  padding:10px 12px; border-radius:12px; width:52%;
}
.search input{
  flex:1; background:transparent; border:none; outline:none; color:var(--text);
}
.actions{display:flex; align-items:center; gap:10px}
.btn{
  background: var(--btn);
  border:1px solid var(--btn-border);
  color:var(--btn-text); padding:10px 12px; border-radius:10px; cursor:pointer;
  transition: filter .15s ease, transform .02s ease;
}
.btn:hover{filter:brightness(1.05)}
.btn:active{transform:translateY(1px)}
.btn.primary{background: var(--btn); border-color: var(--btn-border)}
.btn.ghost{background:transparent; color: var(--btn-text); border-color: var(--btn-border)}
.btn.small{padding:6px 10px; font-size:12px}
.kbd{font: 12px/1.6 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; padding:2px 6px; border-radius:6px; border:1px solid var(--line); color:var(--muted)}

/* Content */
.content{padding:14px 22px 40px}
.page-title{display:flex; align-items:baseline; justify-content:space-between; gap:12px; margin:12px 0 8px 0}
.page-title h2{margin:0; font-size:22px}
.page-title .sub{color:var(--muted)}

/* Cards & sections */
.cards{display:grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap:14px; margin:14px 0 6px}
.card{
  background: var(--card);
  border:1px solid var(--line); border-radius:14px; padding:12px 14px; min-height:72px;
  box-shadow: 0 8px 28px rgba(2,6,23,.06);
}
.card .label{color:var(--muted); font-size:12px}
.card .value{font-size:22px; margin-top:2px}
.card .trend{font-size:12px; color:#047857}
.card .danger{color:var(--danger)}

.grid-2{display:grid; grid-template-columns: 2fr 1fr; gap:16px; margin-top:16px}
.grid-3{display:grid; grid-template-columns: repeat(3, 1fr); gap:16px; margin-top:16px}
.section{background: var(--card); border:1px solid var(--line); border-radius:14px; padding:16px}
.section h3{margin:0 0 10px 0; font-size:16px}

/* Table */
.table{width:100%; border-collapse:separate; border-spacing:0 8px; font-size:14px}
.table th{color:var(--muted); text-align:left; font-weight:600; padding:8px 10px; border-bottom:1px solid var(--line)}
.table td{padding:10px; background:#ffffff; border:1px solid var(--line)}
.table tr td:first-child{border-top-left-radius:10px; border-bottom-left-radius:10px}
.table tr td:last-child{border-top-right-radius:10px; border-bottom-right-radius:10px}

/* Badges & pills */
.badge{font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--line); background:#f8fafc; color:#0b1220}
.badge.ok{border-color:#065f46; background:#ecfdf5; color:#065f46}
.badge.warn{border-color:#92400e; background:#fffbeb; color:#92400e}
.badge.danger{border-color:#7f1d1d; background:#fef2f2; color:#7f1d1d}
.badge.info{border-color:#1e3a8a; background:#eff6ff; color:#1e3a8a}
/* Action task badge in requested color */
.badge.task{border-color:#6f63ff; background:#a399ff; color:#ffffff}

.pills{display:flex; gap:8px; flex-wrap:wrap}
.pill{padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:#f8fafc; cursor:pointer; font-size:12px; color:#0b1220}
.pill.active{background:rgba(33,207,178,0.18); border-color:rgba(33,207,178,0.28)}

/* Progress */
.progress{width:100%; height:10px; border-radius:999px; background:#f1f5f9; border:1px solid var(--line); overflow:hidden}
.progress > span{display:block; height:100%; background:linear-gradient(90deg, var(--progress), rgba(33,207,178,0.85)); width:0%}

/* Stepper */
.stepper{display:flex; gap:10px; flex-wrap:wrap}
.step{display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:10px; border:1px dashed #94a3b8; background:#f8fafc; color:#0b1220}
.step.current{border-style:solid; background:rgba(33,207,178,0.10)}
.step .dot{width:10px; height:10px; border-radius:50%; background:#94a3b8; border:2px solid #cbd5e1}
.step.done .dot{background:#059669; border-color:#059669}
.step.current .dot{background:var(--progress)}

/* Forms */
.form-grid{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px}
.label{font-size:12px; color:var(--muted); margin-bottom:6px}
.input, select, textarea{
  width:100%; background:#ffffff; color:var(--text); border:1px solid var(--line); border-radius:10px; padding:10px 12px
}
.row{display:flex; gap:10px; align-items:center}
hr.sep{border:0; border-top:1px solid var(--line); margin:14px 0}

/* Utilities */
.right{margin-left:auto}
.muted{color:var(--muted)}
.small{font-size:12px}
.space-top{margin-top:10px}
.center{display:flex; align-items:center; justify-content:center}
.hidden{display:none!important}

/* Responsive */
@media (max-width:1100px){
  .app{grid-template-columns: 80px 1fr}
  .brand h1, .footer-note, .nav a .text, .nav a .tag{display:none}
  .nav a{justify-content:center}
  .search{width:70%}
}
@media (max-width:800px){
  .cards{grid-template-columns: repeat(2, 1fr)}
  .grid-2{grid-template-columns: 1fr}
  .grid-3{grid-template-columns: 1fr}
  .form-grid{grid-template-columns: 1fr}
}
</style>
<style>

/* === Enhancements: modal + timeline + stat chips === */
.modal{position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; z-index:999}
.modal .box{background:#fff; border-radius:12px; border:1px solid var(--line); width:min(720px, 92vw); padding:16px; box-shadow:0 20px 60px rgba(0,0,0,.25)}
.modal .box h4{margin:0 0 8px 0}
.modal .box .actions{display:flex; gap:8px; justify-content:flex-end; margin-top:12px}

.timeline{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px}
.tl-step{display:flex; flex-direction:column; align-items:center; gap:4px; min-width:90px}
.tl-dot{width:10px; height:10px; border-radius:50%; background:#e2e8f0; border:2px solid #cbd5e1}
.tl-step.done .tl-dot{background:#059669; border-color:#059669}
.tl-step.pending .tl-dot{background:#e2e8f0}
.tl-label{font-size:12px; color:#0f172a}
.tl-time{font-size:11px; color:#475569}
.tl-line{width:28px; height:2px; background:#cbd5e1}
.timeline .tl-step.pending .tl-label{opacity:0.7}

.stat{display:flex; gap:6px; align-items:center; font-size:12px; border:1px solid var(--line); border-radius:999px; padding:4px 8px; background:#f8fafc}
.stat b{font-weight:700}

</style>
</head>
<body data-page="distributor">

  <a href="#main" class="kbd" style="position:absolute; left:-9999px; top:-9999px">Skip to content</a>
  <div class="app">
    <aside class="sidebar" aria-label="Sidebar Navigation">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>KYC Orchestrator</h1>
      </div>
      <nav class="nav">
        <a href="index.html" data-nav="dashboard" aria-label="Dashboard">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 12l9-9 9 9" stroke="#4976a4" stroke-width="2"/><path d="M5 10v10h5v-6h4v6h5V10" stroke="#4976a4" stroke-width="2"/></svg>
          <span class="text">Dashboard</span>
        </a>
        <a href="fund-launch.html" data-nav="fund-launch" aria-label="Fund Launch">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 19h16M7 19V7a3 3 0 0 1 3-3h4a3 3 0 0 1 3 3v12" stroke="#4976a4" stroke-width="2"/><path d="M9 9h6m-6 4h6" stroke="#4976a4" stroke-width="2"/></svg>
          <span class="text">Fund Launch</span>
        </a>
        <a href="distributor-onboarding.html" data-nav="distributor" aria-label="Distributor Onboarding">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M7 8h10a4 4 0 0 1 4 4v6H3v-6a4 4 0 0 1 4-4z" stroke="#4976a4" stroke-width="2"/><path d="M7 8V6a5 5 0 0 1 10 0v2" stroke="#4976a4" stroke-width="2"/></svg>
          <span class="text">Distributor Onboarding</span>
        </a>
        <a href="investor-onboarding.html" data-nav="investor" aria-label="Investor Onboarding">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5z" stroke="#4976a4" stroke-width="2"/><path d="M3 21a9 9 0 0 1 18 0" stroke="#4976a4" stroke-width="2"/></svg>
          <span class="text">Investor Onboarding</span>
        </a>
        <a href="asset-dd.html" data-nav="asset" aria-label="Asset & Vehicle Due Diligence">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 7h18M3 12h18M3 17h18" stroke="#4976a4" stroke-width="2"/><path d="M8 7v12m8-12v12" stroke="#4976a4" stroke-width="2"/></svg>
          <span class="text">Asset & Vehicle DD</span>
        </a>
        <a href="monitoring.html" data-nav="monitoring" aria-label="Monitoring & Screening">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 13l4 4 12-12" stroke="#4976a4" stroke-width="2"/></svg>
          <span class="text">Monitoring & Screening</span>
        </a>
        <a href="digital-trading.html" data-nav="digital" aria-label="Digital Trading">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M4 6h16v12H4z" stroke="#4976a4" stroke-width="2"/><path d="M8 10h8M8 14h5" stroke="#4976a4" stroke-width="2"/>
          </svg>
          <span class="text">Digital Trading</span>
        </a>
      </nav>
      <div class="footer-note">Prototype â¢ Static HTML â¢ Local storage</div>
    </aside>
    
    <main class="main">
      <header class="header" role="banner">
        <div class="search" role="search" aria-label="Search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="11" cy="11" r="7" stroke="#64748b" stroke-width="1.5"/><path d="M20 20l-3-3" stroke="#64748b" stroke-width="1.5"/></svg>
          <input placeholder="Search parties, products, accounts, casesâ¦ (press / to focus)" aria-label="Global search"/>
          <span class="kbd">/</span>
        </div>
        <div class="actions">
          <button class="btn ghost" aria-label="New case">New Case</button>
          <button class="btn primary" aria-label="Add party">+ Add Party</button>
        </div>
      </header>
      <section class="content" id="main">
        <div class="page-title">
          <h2>Distributor Onboarding</h2>
          <div class="sub">Licensing â¢ KYB/UBO â¢ Attestations â¢ Screening</div>
        </div>
        
<div class="grid-2">
  <div class="section">
    <h3>Distributor Profile</h3>
    <div class="form-grid">
      <div><div class="label">Legal Name</div><input class="input" placeholder="e.g., Alpha Distrib GmbH"/></div>
      <div><div class="label">LEI</div><input class="input" placeholder="e.g., 529900T8BM49AURSDO55"/></div>
      <div><div class="label">Headquarters</div><input class="input" placeholder="Munich, DE"/></div>
      <div><div class="label">Contact</div><input class="input" placeholder="compliance@alpha-distrib.de"/></div>
      <div><div class="label">Onboarding Type</div><select><option>Full</option><option>Lite</option><option>Recertification</option></select></div>
      <div><div class="label">Booked By</div><input class="input" placeholder="S. Weber"/></div>
    </div>
    <hr class="sep"/>
    <h3>Jurisdiction Coverage</h3>
    <div class="row small"><input type="checkbox" id="j1"/> <label for="j1">Germany</label></div>
    <div class="row small"><input type="checkbox" id="j2"/> <label for="j2">France</label></div>
    <div class="row small"><input type="checkbox" id="j3"/> <label for="j3">Netherlands</label></div>
    <div class="row small"><input type="checkbox" id="j4"/> <label for="j4">Spain</label></div>
    <hr class="sep"/>
    <div class="row">
      <button class="btn primary">Save & Continue</button>
      <button class="btn ghost">Attach DDQ</button>
      <button class="btn ghost">Upload SOC/ISAE</button>
    </div>
  </div>
  <div class="section">
    <h3>Risk & Screening</h3>
    <div class="row small"><div style="width:140px">Base Risk Score</div><div class="progress" style="flex:1"><span id="riskBar" data-value="40"></span></div></div>
    <div class="row small space-top"><div style="width:140px">Sanctions/PEP</div><span class="badge ok">No hits</span></div>
    <div class="row small space-top"><div style="width:140px">Adverse Media</div><span class="badge">2 low-sev</span></div>
    <div class="row small space-top"><div style="width:140px">Licensing</div><span class="badge warn">FR pending</span></div>
    <hr class="sep"/>
    <h3>Attestations</h3>
    <div class="row small"><input type="checkbox" id="att1"/> <label for="att1">Target market governance</label></div>
    <div class="row small"><input type="checkbox" id="att2"/> <label for="att2">Inducement & remuneration</label></div>
    <div class="row small"><input type="checkbox" id="att3"/> <label for="att3">Training completed</label></div>
  </div>
</div>

<div class="section">
  <h3>Checklist</h3>
  <table class="table">
    <thead><tr><th>Item</th><th>Owner</th><th>Status</th><th>Due</th></tr></thead>
    <tbody>
      <tr><td>Company Registry Extract</td><td>KYB</td><td><span class="badge ok">Received</span></td><td>â</td></tr>
      <tr><td>UBO Declaration</td><td>KYB</td><td><span class="badge task">Requested</span></td><td>3d</td></tr>
      <tr><td>Cross-Border License (FR)</td><td>Legal</td><td><span class="badge warn">In Review</span></td><td>2d</td></tr>
      <tr><td>Distribution Agreement</td><td>Legal</td><td><span class="badge task">Pending</span></td><td>5d</td></tr>
    </tbody>
  </table>
</div>

<script>
(() => {
  const boxes = Array.from(document.querySelectorAll('input[type=checkbox][id^=j]'));
  const bar = document.getElementById('riskBar');
  const calc = () => {
    const n = boxes.filter(b => b.checked).length;
    const base = 30;
    const val = Math.min(100, base + n*12);
    bar.setAttribute('data-value', val);
    requestAnimationFrame(() => { bar.style.width = '0%'; requestAnimationFrame(() => bar.style.width = val+'%'); });
  };
  boxes.forEach(b => b.addEventListener('change', calc));
  calc();
})();
</script>

      
<div class="section" id="distTracker" aria-label="My Distributors">
  <div class="row">
    <h3>My Distributors</h3>
    <div class="right row">
      <div class="pills" id="distFilters">
        <span class="pill active" data-f="all">All</span>
        <span class="pill" data-f="onboarding">Onboarding</span>
        <span class="pill" data-f="active">Active</span>
        <span class="pill" data-f="recertify">Recertify</span>
      </div>
      <div class="right row">
        <input class="input" id="openDistById" placeholder="Open by ID e.g., D-0001" style="width:200px; margin-left:8px"/>
        <button class="btn small" id="openDistByIdBtn">Open</button>
      </div>
    </div>
  </div>
  <div class="row small space-top">
    <span class="stat"><span class="muted">Onboarding</span> <b id="dOnYTD">0</b> YTD â¢ <b id="dOnMTD">0</b> MTD</span>
    <span class="stat"><span class="muted">Active</span> <b id="dActYTD">0</b> YTD â¢ <b id="dActMTD">0</b> MTD</span>
    <span class="stat"><span class="muted">Pending reviews</span> <b id="dPendYTD">0</b> YTD â¢ <b id="dPendMTD">0</b> MTD</span>
  </div>
  <table class="table space-top" id="distTable">
    <thead><tr><th>ID</th><th>Name</th><th>Jurisdictions</th><th>Status</th><th>Pending</th><th>Next Review</th><th>Updated</th></tr></thead>
    <tbody></tbody>
  </table>
  <div class="small muted">Click a row for details. Use âSave & Continueâ to add/update the current distributor. New action buttons (**Approve Onboarding** / **Start Recertification**) have been added inline.</div>
</div>

<!-- Detail Modal -->
<div id="distModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="Distributor detail">
  <div class="box">
    <h4 id="distModalTitle">Distributor</h4>
    <div id="distModalBody" class="small"></div>
    <div class="actions"><button class="btn" id="distModalClose">Close</button></div>
  </div>
</div>

</section>
    </main>
  </div>
  <script>
(() => {
  const body = document.body;
  const page = body.getAttribute('data-page');
  // Activate nav
  document.querySelectorAll('.nav a').forEach(a => { if (a.dataset.nav === page) a.classList.add('active'); });
  // Animate progress
  const animate = () => {
    document.querySelectorAll('.progress > span[data-value]').forEach(el => {
      const v = parseInt(el.getAttribute('data-value'),10) || 0;
      el.style.width = '0%';
      setTimeout(() => el.style.width = v + '%', 120);
    });
  };
  animate();
  // "/" shortcut to focus search
  window.addEventListener('keydown', (e) => {
    if (e.key === '/' && !/input|textarea|select/i.test(document.activeElement.tagName)) {
      const i = document.querySelector('.search input'); if (i) { e.preventDefault(); i.focus(); }
    }
  });
})();
</script>
  
<script>

(() => {
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const fmtTS = (ts) => ts ? new Date(ts).toLocaleString() : 'â';
  const pad = (n) => n.toString().padStart(4,'0');
  const now = new Date();
  const y = now.getFullYear(), m = now.getMonth();
  const inYear = (ts) => ts && new Date(ts).getFullYear() === y;
  const inMonth = (ts) => ts && new Date(ts).getFullYear() === y && new Date(ts).getMonth() === m;

  // Storage
  const KEY = 'kyc_distributors';
  const read = () => { try { return JSON.parse(localStorage.getItem(KEY) || '[]'); } catch(e){ return []; } };
  const write = (list) => { localStorage.setItem(KEY, JSON.stringify(list)); window.dispatchEvent(new StorageEvent('storage', {key:KEY, newValue:JSON.stringify(list)})); };
  const nextId = (list) => {
    const max = list.reduce((m,t)=> Math.max(m, parseInt((t.id||'').split('-')[1]||'0',10)), 0);
    return `D-${pad(max+1)}`;
  };

  // Seed if empty with a sample
  let recs = read();
  if (!recs.length) {
    recs = [{
      id:'D-0001', name:'Alpha Distrib GmbH', lei:'529900T8BM49AURSDO55', hq:'Munich, DE', contact:'compliance@alpha-distrib.de',
      type:'Full', bookedBy:'S. Weber', jurisdictions:['DE','FR'], att:{att1:true, att2:false, att3:false},
      files:{ddq:['AIMA_DDQ_v1.3.pdf'], soc:['ISAE3402_2024.pdf']},
      riskScore:52, status:'onboarding', pendingReviews:3, startDate: Date.now()-86400000*21, approvedDate:null,
      nextReviewDate:null, updatedAt: Date.now()-86400000*1,
      timeline:{kyb: Date.now()-86400000*20, licensing: Date.now()-86400000*15, attestations: null, screening: Date.now()-86400000*7, approved: null}
    }];
    write(recs);
  }

  // Helper: read form fields by label text
  const getFieldByLabel = (labelText) => {
    const lbl = $$('.label').find(d => (d.textContent||'').trim().toLowerCase() === labelText.toLowerCase());
    if (!lbl) return null;
    const wrap = lbl.parentElement;
    return $('input, select, textarea', wrap);
  };
  const getFormValues = () => {
    const name = (getFieldByLabel('Legal Name')?.value || '').trim();
    const lei = (getFieldByLabel('LEI')?.value || '').trim();
    const hq = (getFieldByLabel('Headquarters')?.value || '').trim();
    const contact = (getFieldByLabel('Contact')?.value || '').trim();
    const type = (getFieldByLabel('Onboarding Type')?.value || '').trim();
    const bookedBy = (getFieldByLabel('Booked By')?.value || '').trim();
    const jurisdictions = [
      $('#j1')?.checked ? 'DE' : null,
      $('#j2')?.checked ? 'FR' : null,
      $('#j3')?.checked ? 'NL' : null,
      $('#j4')?.checked ? 'ES' : null
    ].filter(Boolean);
    const att = { att1: $('#att1')?.checked || false, att2: $('#att2')?.checked || false, att3: $('#att3')?.checked || false };
    return { name, lei, hq, contact, type, bookedBy, jurisdictions, att };
  };

  const computeRisk = (vals) => {
    let risk = 30;
    risk += (vals.jurisdictions.length * 12);
    risk += (!vals.lei ? 10 : 0);
    risk += (vals.type === 'Full' ? 6 : 0);
    const attCount = ['att1','att2','att3'].reduce((n,k)=> n + (vals.att[k] ? 1 : 0), 0);
    risk -= attCount * 6;
    return Math.min(100, Math.max(0, risk));
  };
  const computePending = (vals, files) => {
    let n = 0;
    n += (!vals.lei ? 1 : 0);
    n += ['att1','att2','att3'].reduce((c,k)=> c + (vals.att[k] ? 0 : 1), 0);
    n += (!files?.ddq?.length ? 1 : 0);
    return n;
  };

  // Inject action buttons next to "Save & Continue"
  const profileSection = $$('.section').find(s => $('h3', s)?.textContent.trim() === 'Distributor Profile');
  if (profileSection) {
    const btnRow = $$('.row', profileSection).reverse().find(r => $$('button', r).length > 0);
    if (btnRow && !$('#approveBtn')) {
      const approve = document.createElement('button');
      approve.id = 'approveBtn'; approve.className = 'btn small'; approve.textContent = 'Approve Onboarding';
      const recert = document.createElement('button');
      recert.id = 'recertBtn'; recert.className = 'btn ghost small'; recert.textContent = 'Start Recertification';
      btnRow.insertBefore(approve, btnRow.firstChild.nextSibling); // after the first button
      btnRow.insertBefore(recert, approve.nextSibling);
    }
  }

  // Hidden file inputs for DDQ/SOC capture
  const ddqInput = document.createElement('input'); ddqInput.type = 'file'; ddqInput.multiple = true; ddqInput.className = 'hidden';
  const socInput = document.createElement('input'); socInput.type = 'file'; socInput.multiple = true; socInput.className = 'hidden';
  document.body.appendChild(ddqInput); document.body.appendChild(socInput);

  // Wire buttons by label text
  const allButtons = $$('button');
  const btnSave = allButtons.find(b => (b.textContent||'').toLowerCase().includes('save') && (b.textContent||'').toLowerCase().includes('continue'));
  const btnDDQ = allButtons.find(b => (b.textContent||'').toLowerCase().includes('ddq'));
  const btnSOC = allButtons.find(b => (b.textContent||'').toLowerCase().includes('soc'));
  const btnApprove = $('#approveBtn');
  const btnRecert = $('#recertBtn');

  // Current working record id is kept on the content section dataset
  const page = $('#main'); if (page && !page.dataset.distId) page.dataset.distId = '';

  // Save handler
  const saveHandler = () => {
    const vals = getFormValues();
    if (!vals.name) { alert('Enter Legal Name before saving.'); return; }
    let list = read();
    const id = page.dataset.distId || nextId(list);
    let rec = list.find(x => x.id === id);
    if (!rec) {
      rec = { id, startDate: Date.now(), status:'onboarding', files:{ddq:[], soc:[]}, timeline:{} };
      list.push(rec);
    }
    // update record
    rec.name = vals.name; rec.lei = vals.lei; rec.hq = vals.hq; rec.contact = vals.contact;
    rec.type = vals.type || 'Full'; rec.bookedBy = vals.bookedBy || '';
    rec.jurisdictions = vals.jurisdictions; rec.att = vals.att;
    // timeline heuristics
    rec.timeline = rec.timeline || {};
    if (vals.lei && !rec.timeline.kyb) rec.timeline.kyb = Date.now();
    if (vals.jurisdictions.length && !rec.timeline.licensing) rec.timeline.licensing = Date.now();
    if (vals.att.att1 && vals.att.att2 && vals.att.att3 && !rec.timeline.attestations) rec.timeline.attestations = Date.now();
    if (!rec.timeline.screening) rec.timeline.screening = Date.now(); // simple demo assumption
    rec.riskScore = computeRisk(vals);
    rec.pendingReviews = computePending(vals, rec.files);
    rec.updatedAt = Date.now();
    page.dataset.distId = rec.id;
    write(list);
    renderList(currentFilter());
    animateRisk(rec.riskScore);
  };

  if (btnSave) btnSave.addEventListener('click', saveHandler);

  // Attach DDQ/SOC capture
  if (btnDDQ) btnDDQ.addEventListener('click', () => ddqInput.click());
  if (btnSOC) btnSOC.addEventListener('click', () => socInput.click());
  const onFiles = (kind, files) => {
    if (!files || !files.length) return;
    const list = read(); const id = page.dataset.distId || null;
    if (!id) { alert('Save the distributor first so files can be associated.'); return; }
    const rec = list.find(x => x.id === id); if (!rec) return;
    rec.files = rec.files || {ddq:[], soc:[]};
    const names = Array.from(files).map(f => f.name);
    rec.files[kind] = (rec.files[kind] || []).concat(names);
    rec.updatedAt = Date.now();
    write(list); renderList(currentFilter());
  };
  ddqInput.addEventListener('change', (e) => onFiles('ddq', e.target.files));
  socInput.addEventListener('change', (e) => onFiles('soc', e.target.files));

  // Approve & Recertify
  if (btnApprove) btnApprove.addEventListener('click', () => {
    const list = read(); const id = page.dataset.distId || null; if (!id) return alert('Save first.');
    const rec = list.find(x => x.id === id); if (!rec) return;
    rec.status = 'active'; rec.approvedDate = Date.now(); rec.pendingReviews = 0; rec.timeline = rec.timeline || {}; rec.timeline.approved = rec.approvedDate;
    // next review 12 months
    const d = new Date(rec.approvedDate); d.setMonth(d.getMonth()+12); rec.nextReviewDate = d.getTime();
    rec.updatedAt = Date.now(); write(list); renderList(currentFilter());
  });
  if (btnRecert) btnRecert.addEventListener('click', () => {
    const list = read(); const id = page.dataset.distId || null; if (!id) return alert('Save first.');
    const rec = list.find(x => x.id === id); if (!rec) return;
    rec.status = 'recertify'; const d = new Date(); d.setMonth(d.getMonth()+1); rec.nextReviewDate = d.getTime();
    rec.updatedAt = Date.now(); write(list); renderList(currentFilter());
  });

  // Risk bar animation
  const riskBar = $('#riskBar');
  const animateRisk = (val) => {
    if (!riskBar) return;
    riskBar.setAttribute('data-value', val);
    riskBar.style.width = '0%'; requestAnimationFrame(() => { riskBar.style.width = val + '%'; });
  };
  // Recalc risk on jurisdiction/attestation change
  ['#j1','#j2','#j3','#j4','#att1','#att2','#att3'].forEach(s => {
    const el = $(s); if (el) el.addEventListener('change', () => {
      const vals = getFormValues(); animateRisk(computeRisk(vals));
    });
  });

  // My Distributors list & modal
  const tableBody = $('#distTable tbody');
  const filters = $('#distFilters');
  const openById = $('#openDistById'); const openBtn = $('#openDistByIdBtn');

  const currentFilter = () => (filters.querySelector('.pill.active')?.dataset.f) || 'all';

  const renderMIS = (list) => {
    const onYTD = list.filter(r => r.status==='onboarding' && inYear(r.startDate)).length;
    const onMTD = list.filter(r => r.status==='onboarding' && inMonth(r.startDate)).length;
    const actYTD = list.filter(r => r.status==='active' && inYear(r.approvedDate)).length;
    const actMTD = list.filter(r => r.status==='active' && inMonth(r.approvedDate)).length;
    const pendYTD = list.filter(r => r.status!=='active' && inYear(r.startDate)).reduce((a,r)=> a + (r.pendingReviews||0), 0);
    const pendMTD = list.filter(r => r.status!=='active' && inMonth(r.startDate)).reduce((a,r)=> a + (r.pendingReviews||0), 0);
    $('#dOnYTD').textContent = onYTD; $('#dOnMTD').textContent = onMTD;
    $('#dActYTD').textContent = actYTD; $('#dActMTD').textContent = actMTD;
    $('#dPendYTD').textContent = pendYTD; $('#dPendMTD').textContent = pendMTD;
  };

  const renderList = (flt='all') => {
    const list = read();
    renderMIS(list);
    const view = list.filter(r => flt==='all' ? true : r.status===flt);
    tableBody.innerHTML = view.map(r => `
      <tr data-id="${r.id}" style="cursor:pointer">
        <td>${r.id}</td>
        <td>${r.name||'â'}</td>
        <td>${(r.jurisdictions||[]).join(', ')||'â'}</td>
        <td><span class="badge ${r.status==='active' ? 'ok' : (r.status==='recertify' ? 'warn' : 'task')}">${r.status||'onboarding'}</span></td>
        <td>${r.pendingReviews||0}</td>
        <td>${r.nextReviewDate ? new Date(r.nextReviewDate).toLocaleDateString() : 'â'}</td>
        <td>${fmtTS(r.updatedAt)}</td>
      </tr>
    `).join('');
    // Row click => modal
    $$('#distTable tbody tr').forEach(tr => tr.addEventListener('click', () => {
      const id = tr.getAttribute('data-id'); const rec = read().find(x=>x.id===id); if (!rec) return;
      const tl = rec.timeline || {};
      const steps = [
        {key:'kyb', label:'KYB', ts: tl.kyb || null},
        {key:'licensing', label:'Licensing', ts: tl.licensing || null},
        {key:'attestations', label:'Attestations', ts: tl.attestations || null},
        {key:'screening', label:'Screening', ts: tl.screening || null},
        {key:'approved', label:'Approved', ts: tl.approved || rec.approvedDate || null},
      ];
      const tlHtml = steps.map((s, i) => {
        const done = !!s.ts;
        const timeTxt = done ? new Date(s.ts).toLocaleString() : 'â';
        return `
          <div class="tl-step ${done ? 'done':'pending'}">
            <div class="tl-dot"></div>
            <div class="tl-label">${s.label}</div>
            <div class="tl-time">${timeTxt}</div>
          </div>
          ${i < steps.length - 1 ? '<div class="tl-line"></div>' : ''}
        `;
      }).join('');
      $('#distModalTitle').textContent = `Distributor ${rec.id}`;
      $('#distModalBody').innerHTML = `
        <div class="row small"><div style="width:140px">Name</div><div>${rec.name}</div></div>
        <div class="row small"><div style="width:140px">LEI</div><div>${rec.lei||'â'}</div></div>
        <div class="row small"><div style="width:140px">HQ</div><div>${rec.hq||'â'}</div></div>
        <div class="row small"><div style="width:140px">Contact</div><div>${rec.contact||'â'}</div></div>
        <div class="row small"><div style="width:140px">Type</div><div>${rec.type||'â'}</div></div>
        <div class="row small"><div style="width:140px">Jurisdictions</div><div>${(rec.jurisdictions||[]).join(', ')||'â'}</div></div>
        <div class="row small"><div style="width:140px">Status</div><div>${rec.status}</div></div>
        <div class="row small"><div style="width:140px">Pending reviews</div><div>${rec.pendingReviews||0}</div></div>
        <div class="row small"><div style="width:140px">Started</div><div>${fmtTS(rec.startDate)}</div></div>
        <div class="row small"><div style="width:140px">Approved</div><div>${fmtTS(rec.approvedDate)}</div></div>
        <hr class="sep"/>
        <div class="small"><b>Timeline</b></div>
        <div class="timeline">${tlHtml}</div>
        <div class="actions"><button class="btn" id="openInEditor">Open in Editor</button></div>
      `;
      $('#distModal').classList.remove('hidden');
      $('#openInEditor').addEventListener('click', () => { $('#distModal').classList.add('hidden'); loadIntoForm(rec.id); });
    }));
  };

  // Filter pills & open by ID
  filters.addEventListener('click', (e) => {
    const p = e.target.closest('.pill'); if (!p) return;
    $$('.pill', filters).forEach(x => x.classList.remove('active')); p.classList.add('active');
    renderList(p.dataset.f);
  });
  openBtn.addEventListener('click', () => { const id = (openById.value||'').trim(); if (id) loadIntoForm(id); });
  openById.addEventListener('keydown', (e) => { if (e.key==='Enter') openBtn.click(); });

  // Load a record into the form
  const loadIntoForm = (id) => {
    const rec = read().find(x => x.id === id);
    if (!rec) { alert('Not found: ' + id); return; }
    page.dataset.distId = rec.id;
    // Text/select fields
    const setVal = (label, v) => { const el = getFieldByLabel(label); if (el) { if (el.tagName==='SELECT') { el.value = v; } else { el.value = v||''; } } };
    setVal('Legal Name', rec.name);
    setVal('LEI', rec.lei);
    setVal('Headquarters', rec.hq);
    setVal('Contact', rec.contact);
    setVal('Onboarding Type', rec.type);
    setVal('Booked By', rec.bookedBy);
    // Jurisdictions
    const map = {DE:'#j1', FR:'#j2', NL:'#j3', ES:'#j4'};
    ['#j1','#j2','#j3','#j4'].forEach(s => { const el = $(s); if (el) el.checked = false; });
    (rec.jurisdictions||[]).forEach(code => { const s = map[code]; const el = s && $(s); if (el) el.checked = true; });
    // Attestations
    if ($('#att1')) $('#att1').checked = !!(rec.att?.att1);
    if ($('#att2')) $('#att2').checked = !!(rec.att?.att2);
    if ($('#att3')) $('#att3').checked = !!(rec.att?.att3);
    // Risk bar
    animateRisk(rec.riskScore || 40);
    // Scroll to top of form
    window.scrollTo({top: 0, behavior: 'smooth'});
  };

  // Modal close
  $('#distModalClose').addEventListener('click', () => $('#distModal').classList.add('hidden'));
  $('#distModal').addEventListener('click', (e) => { if (e.target === $('#distModal')) $('#distModal').classList.add('hidden'); });

  // Initial render
  renderList('all');

  // Open by URL hash (#D-0001)
  if (location.hash && location.hash.startsWith('#D-')) { loadIntoForm(location.hash.slice(1)); }
})();

</script>
</body>
</html>
